<!doctype html>
<html lang="ja">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4QH9F5T9PD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4QH9F5T9PD');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>整形相談室</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="wrap">
    <h1>整形相談室（匿名Q&A）</h1>
    <nav>
      <a href="index.html">一覧</a>
      <a href="ask.html">質問する</a>
      <a href="rank.html">ランキング</a>

    </nav>
  </div>
</header>

<main>
  <div id="maintBox" class="card" style="display:none">
    <div class="notice">
      <b>メンテナンス中：</b><span id="maintMsg"></span><br>
      現在「投稿」は停止中です（閲覧は可能）。
    </div>
  </div>

  <div class="card">
    <div class="notice">
      <b>注意：</b>医師名・店舗の詳細・個人情報は書かない。断定や誹謗中傷ではなく「不安/疑問」の形に。<br>
      NG例：<span class="kbd">詐欺</span> <span class="kbd">医療ミス</span> <span class="kbd">潰れろ</span> などの断定・攻撃ワード
    </div>

    <div class="muted" style="margin-top:10px">スペース区切り＝掛け算検索（AND）。タグをクリックすると検索に追加。</div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>検索（AND検索）</label>
        <input id="search" placeholder="例：埋没 ダウンタイム / 親バレ 会社" />
      </div>
      <div>
        <label>並び替え</label>
        <select id="sort">
          <option value="like" selected>共感が多い順（おすすめ）</option>
          <option value="new">新しい順</option>
          <option value="ans">回答が多い順</option>
          <option value="old">古い順</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>カテゴリ絞り込み</label>
        <select id="cat">
          <option value="">指定なし</option>
          <option>二重</option><option>鼻</option><option>輪郭</option><option>目元（クマ等）</option>
          <option>美容皮膚</option><option>脱毛</option><option>その他</option>
        </select>
      </div>
      <div>
        <label>地域絞り込み</label>
        <select id="reg">
          <option value="">指定なし</option>
          <option>東京</option><option>神奈川</option><option>埼玉</option><option>千葉</option>
          <option>大阪</option><option>その他</option>
        </select>
      </div>
    </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
    <div id="list" style="margin-top:10px"></div>

    <div class="pager">
      <button id="prev">前へ</button>
      <span class="muted" id="pageInfo"></span>
      <button id="next">次へ</button>
    </div>
  </div>
</main>

<script type="module">
  import { listQuestions, tokenize, andMatch, esc, getSiteConfig } from "./app.js";

  const PAGE_SIZE = 20;
  let page = 1;
  let all = [];
  let filtered = [];

  function buildHay(q){
    const d=q.data;
    const tags = Array.isArray(d.tags) ? d.tags.join(" ") : "";
    return `${d.title||""} ${d.body||""} ${d.category||""} ${d.region||""} ${tags}`;
  }

  function sortList(list, sort){
    const cp = list.slice();
    if(sort==="old") return cp.reverse();
    if(sort==="like") return cp.sort((a,b)=> (b.data.likeCount||0) - (a.data.likeCount||0));
    if(sort==="ans")  return cp.sort((a,b)=> (b.data.answerCount||0) - (a.data.answerCount||0));
    return cp; // new（createdAt descのまま）
  }

  function apply(){
    const tokens = tokenize(document.getElementById("search").value);
    const cat = document.getElementById("cat").value;
    const reg = document.getElementById("reg").value;
    const sort = document.getElementById("sort").value;

    filtered = all
      .filter(q => !q.data?.deleted) // ソフト削除は表示しない
      .filter(q=>{
        const d=q.data;
        if(cat && d.category !== cat) return false;
        if(reg && d.region !== reg) return false;
        return andMatch(buildHay(q), tokens);
      });

    filtered = sortList(filtered, sort);
    page = 1;
    render();
  }

  function render(){
    const el = document.getElementById("list");
    const total = filtered.length;
    if(total===0){
      el.innerHTML = `<div class="muted">該当する質問がありません。</div>`;
      document.getElementById("pageInfo").textContent = "";
      document.getElementById("prev").disabled = true;
      document.getElementById("next").disabled = true;
      return;
    }

    const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if(page > maxPage) page = maxPage;

    const start = (page-1)*PAGE_SIZE;
    const view = filtered.slice(start, start+PAGE_SIZE);

    el.innerHTML = view.map(q=>{
      const d=q.data;
      const tags = Array.isArray(d.tags) ? d.tags : [];
      return `
        <div class="qitem">
          <div class="row" style="justify-content:space-between">
            <div class="qtitle"><a href="q.html?id=${encodeURIComponent(q.id)}">${esc(d.title)}</a></div>
            <span class="badge">${esc(d.category||"")}</span>
          </div>
          <div class="qmeta">
            <small>地域：${esc(d.region||"未設定")}</small>
            <small>投稿者：${esc(d.displayName||"匿名")}${d.social?`（${esc(d.social)}）`:""}</small>
            <small>共感：${d.likeCount||0}</small>
            <small>回答：${d.answerCount||0}</small>
          </div>
          <div class="muted" style="margin-top:8px">${esc((d.body||"").slice(0,140))}${(d.body||"").length>140?"…":""}</div>
          <div style="margin-top:8px">
            ${tags.map(t=>`<span class="pill tag" data-tag="${esc(t)}">#${esc(t)}</span>`).join("")}
          </div>
          <div class="inline-actions">
            <button class="btn ghost shareBtn" data-url="${location.origin + location.pathname.replace(/index\\.html$/, '')}q.html?id=${encodeURIComponent(q.id)}" style="width:auto">URLコピー</button>
          </div>
        </div>
      `;
    }).join("");

    document.getElementById("pageInfo").textContent = `${page} / ${maxPage}`;
    document.getElementById("prev").disabled = page<=1;
    document.getElementById("next").disabled = page>=maxPage;
  }

  // タグクリック → 検索欄に追加（AND検索）
  document.addEventListener("click", (e)=>{
    const t = e.target;
    if(t.classList.contains("tag")){
      const tag = t.dataset.tag || "";
      const s = document.getElementById("search");
      const cur = s.value.trim();
      const next = cur ? `${cur} ${tag}` : tag;
      s.value = next;
      apply();
    }
    if(t.classList.contains("shareBtn")){
      const url = t.dataset.url;
      navigator.clipboard.writeText(url).then(()=>alert("URLをコピーしました")).catch(()=>alert("コピーできませんでした"));
    }
  });

  document.getElementById("prev").addEventListener("click", ()=>{ page=Math.max(1,page-1); render(); });
  document.getElementById("next").addEventListener("click", ()=>{ page=page+1; render(); });

  ["search","cat","reg","sort"].forEach(id=>{
    document.getElementById(id).addEventListener("input", apply);
    document.getElementById(id).addEventListener("change", apply);
  });

  async function init(){
    const status = document.getElementById("status");
    status.textContent = "読み込み中…";

    const cfg = await getSiteConfig().catch(()=>({maintenance:false,message:""}));
    if(cfg.maintenance){
      document.getElementById("maintBox").style.display = "block";
      document.getElementById("maintMsg").textContent = cfg.message || "しばらくお待ちください。";
    }

    try{
      all = await listQuestions();
      status.textContent = "";
      apply();
    }catch(e){
      console.error(e);
      status.textContent = "読み込みエラー：" + (e?.message || e);
    }
  }

  init();
</script>
</body>
</html>

