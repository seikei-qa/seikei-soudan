<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ•´å½¢ç›¸è«‡Q&A</title>

  <!-- Google Analyticsï¼ˆæ®‹ã™ï¼‰ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4QH9F5T9PD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4QH9F5T9PD');
  </script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;margin:0;background:#f6f7fb;color:#111;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;}
    .brand{font-weight:800;font-size:18px}
    .muted{color:#666}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:12px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .btn{border:1px solid #cfd5e5;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.ghost{background:#fff}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"]{padding:8px;border-radius:10px;border:1px solid #cfd5e5;min-width:220px}
    select{padding:8px;border-radius:10px;border:1px solid #cfd5e5}
    a{color:#111;text-decoration:none}
    a:hover{text-decoration:underline}
    .qmeta{font-size:13px;color:#666;margin-top:4px}
    .pill{display:inline-block;font-size:12px;border:1px solid #e6e8ef;border-radius:999px;padding:2px 8px;margin-left:6px}
    .new{color:#d00;border-color:#ffd1d1;background:#fff5f5}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){ .grid3{grid-template-columns:1fr} }
    .miniItem{margin:8px 0}
    .miniItem .meta{font-size:12px;color:#777;margin-top:2px}
    .list .card{margin-bottom:12px}
    .divider{height:1px;background:#e6e8ef;margin:12px 0}

    /* æœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ2ã€œ3è¡Œï¼‰ */
    .snippet{
      margin-top:8px;
      color:#333;
      font-size:14px;
      line-height:1.45;
      display:-webkit-box;
      -webkit-line-clamp:3;      /* 3è¡Œã¾ã§è¡¨ç¤º */
      -webkit-box-orient:vertical;
      overflow:hidden;
      white-space:normal;
    }

    /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
    .pager{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pager .pages{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pageBtn{
      border:1px solid #cfd5e5;background:#fff;border-radius:10px;
      padding:6px 10px;cursor:pointer;font-size:13px
    }
    .pageBtn.active{background:#111;color:#fff;border-color:#111}
    .pageBtn:disabled{opacity:.45;cursor:not-allowed}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">æ•´å½¢ç›¸è«‡Q&A</div>
      <div class="controls">
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã¸ã®å°ç·šï¼ˆã“ã“ãŒç›´ã£ã¦ã‚‹ï¼‰ -->
        <!-- ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«åãŒé•ã†ãªã‚‰ href ã‚’åˆã‚ã›ã¦ã­ï¼ˆä¾‹ï¼šleaderboard.html ãªã©ï¼‰ -->
        <a class="btn ghost" href="rank.html">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a class="btn primary" href="ask.html">ï¼‹ è³ªå•ã™ã‚‹</a>
      </div>
    </div>

    <!-- ğŸ””é€šçŸ¥ -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div style="font-weight:800">ğŸ”” é€šçŸ¥ï¼ˆã‚ãªãŸå®›ã¦ï¼‰</div>
        <button id="reloadNotiBtn" class="btn ghost" style="width:auto">æ›´æ–°</button>
      </div>
      <div id="notiBox" class="muted" style="margin-top:8px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="muted" style="font-size:12px;margin-top:6px">
        â€»é€šçŸ¥ã¯ã€Œå›ç­”ãƒ»è¿”ä¿¡ãƒ»ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ãƒ»ãŠç¤¼ã€ãŒç™ºç”Ÿã—ãŸã¨ãã«æºœã¾ã‚Šã¾ã™
      </div>
    </div>

    <div class="divider"></div>

    <!-- ğŸ”¥æ€¥ä¸Šæ˜‡ / ğŸ†äººæ°— / ğŸŸ¡æœªè§£æ±º -->
    <div class="grid3">
      <div class="card">
        <div style="font-weight:800">ğŸ”¥ æ€¥ä¸Šæ˜‡</div>
        <div id="trendingBox" class="muted" style="margin-top:8px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
      <div class="card">
        <div style="font-weight:800">ğŸ† äººæ°—è³ªå•</div>
        <div id="popularBox" class="muted" style="margin-top:8px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
      <div class="card">
        <div style="font-weight:800">ğŸŸ¡ æœªè§£æ±ºï¼ˆãƒ™ã‚¹ãƒˆæœªæ±ºï¼‰</div>
        <div id="unbestBox" class="muted" style="margin-top:8px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- æ¤œç´¢ & ä¸¦ã³æ›¿ãˆ -->
    <div class="card">
      <div class="controls">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šåŸ‹æ²¡ / é¼» / å¾Œæ‚” / è¦ªãƒãƒ¬ï¼‰" />
        <select id="sortMode">
          <option value="like">å…±æ„Ÿã®å¤šã„é †</option>
          <option value="new">æ–°ã—ã„é †</option>
          <option value="old">å¤ã„é †</option>
          <option value="unbest">ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼æœªæ±º</option>
          <option value="many">å›ç­”å¤šã„é †</option>
          <option value="few">å›ç­”å°‘ãªã„é †</option>
        </select>
        <button id="clearBtn" class="btn ghost" style="width:auto">ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="muted" style="font-size:12px;margin-top:6px">
        ãƒ’ãƒ³ãƒˆï¼šå›ç­”è€…ã¯ã€Œæœªè§£æ±ºã€ã‚„ã€Œå›ç­”å°‘ãªã„é †ã€ã‚’è¦‹ã‚‹ã¨ç­”ãˆã‚„ã™ã„ã§ã™
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šï¼‰ -->
    <div class="card">
      <div class="pager">
        <div class="muted" id="resultInfo">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        <div class="pages" id="pagerTop"></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- è³ªå•ä¸€è¦§ -->
    <div id="list" class="list"></div>

    <div style="height:12px"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ï¼‰ -->
    <div class="card">
      <div class="pager">
        <div class="muted" id="resultInfo2"> </div>
        <div class="pages" id="pagerBottom"></div>
      </div>
    </div>

  </div>

  <script type="module">
    import {
      listQuestions, esc,
      listMyNotifications, markNotificationRead
    } from "./app.js";

    let all = [];
    let filteredSorted = [];

    const PAGE_SIZE = 20;
    let currentPage = 1;

    function scoreTrending(d){
      const like = d.likeCount || 0;
      const sec  = d.createdAt?.seconds || 0;
      const ageH = Math.max(1, (Date.now()/1000 - sec) / 3600);
      return like / Math.pow(ageH + 2, 0.7);
    }

    function fmtMiniItem(q){
      const d = q.data || {};
      const title = esc(d.title || "(ç„¡é¡Œ)");
      const a = d.answerCount || 0;
      const l = d.likeCount || 0;
      const solved = d.bestAnswerId ? "ğŸ†" : "ğŸŸ¡";
      return `
        <div class="miniItem">
          <a href="q.html?id=${q.id}">${solved} ${title}</a>
          <div class="meta">å›ç­”:${a} / å…±æ„Ÿ:${l}</div>
        </div>
      `;
    }

    function renderTopBoxes(){
      const live = all.filter(q => !q.data?.deleted);

      const popular  = [...live].sort((a,b)=>(b.data.likeCount||0)-(a.data.likeCount||0)).slice(0,5);
      const trending = [...live].sort((a,b)=>scoreTrending(b.data)-scoreTrending(a.data)).slice(0,5);
      const unbest   = live
        .filter(q=>!q.data.bestAnswerId)
        .sort((a,b)=>(b.data.createdAt?.seconds||0)-(a.data.createdAt?.seconds||0))
        .slice(0,5);

      document.getElementById("popularBox").innerHTML  = popular.length  ? popular.map(fmtMiniItem).join("")  : "ã¾ã ã‚ã‚Šã¾ã›ã‚“";
      document.getElementById("trendingBox").innerHTML = trending.length ? trending.map(fmtMiniItem).join("") : "ã¾ã ã‚ã‚Šã¾ã›ã‚“";
      document.getElementById("unbestBox").innerHTML   = unbest.length   ? unbest.map(fmtMiniItem).join("")   : "æœªè§£æ±ºãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã™ã”ã„ï¼‰";
    }

    function getFilteredSorted(){
      const kw = (document.getElementById("searchInput")?.value || "").toLowerCase().trim();
      const mode = document.getElementById("sortMode")?.value || "like";

      let arr = all.filter(q => !q.data?.deleted);

      if(kw){
        arr = arr.filter(q=>{
          const t = (q.data.title||"").toLowerCase();
          const b = (q.data.body||"").toLowerCase();
          return t.includes(kw) || b.includes(kw);
        });
      }

      if(mode === "like"){
        arr.sort((a,b)=>(b.data.likeCount||0)-(a.data.likeCount||0));
      }else if(mode === "new"){
        arr.sort((a,b)=>(b.data.createdAt?.seconds||0)-(a.data.createdAt?.seconds||0));
      }else if(mode === "old"){
        arr.sort((a,b)=>(a.data.createdAt?.seconds||0)-(b.data.createdAt?.seconds||0));
      }else if(mode === "unbest"){
        arr = arr.filter(q=>!q.data.bestAnswerId);
        arr.sort((a,b)=>(b.data.createdAt?.seconds||0)-(a.data.createdAt?.seconds||0));
      }else if(mode === "many"){
        arr.sort((a,b)=>(b.data.answerCount||0)-(a.data.answerCount||0));
      }else if(mode === "few"){
        arr.sort((a,b)=>(a.data.answerCount||0)-(b.data.answerCount||0));
      }

      return arr;
    }

    function renderPager(totalItems){
      const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
      currentPage = Math.min(currentPage, totalPages);

      const infoText = `å…¨ ${totalItems} ä»¶ / ${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ï¼ˆ1ãƒšãƒ¼ã‚¸ ${PAGE_SIZE} ä»¶ï¼‰`;
      document.getElementById("resultInfo").textContent = infoText;
      document.getElementById("resultInfo2").textContent = infoText;

      const make = (rootId)=>{
        const root = document.getElementById(rootId);
        root.innerHTML = "";

        const prev = document.createElement("button");
        prev.className = "pageBtn";
        prev.textContent = "â† å‰ã¸";
        prev.disabled = currentPage <= 1;
        prev.onclick = ()=>{ currentPage--; renderList(); };
        root.appendChild(prev);

        // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆå¤šã™ãã‚‹ã¨é‚ªé­”ãªã®ã§æœ€å¤§7å€‹è¡¨ç¤ºï¼‰
        const totalPagesLocal = totalPages;
        const windowSize = 7;
        let start = Math.max(1, currentPage - Math.floor(windowSize/2));
        let end = Math.min(totalPagesLocal, start + windowSize - 1);
        start = Math.max(1, end - windowSize + 1);

        if(start > 1){
          root.appendChild(pageBtn(1));
          if(start > 2){
            const dots = document.createElement("span");
            dots.className = "muted";
            dots.textContent = "â€¦";
            root.appendChild(dots);
          }
        }

        for(let p=start; p<=end; p++){
          root.appendChild(pageBtn(p));
        }

        if(end < totalPagesLocal){
          if(end < totalPagesLocal - 1){
            const dots = document.createElement("span");
            dots.className = "muted";
            dots.textContent = "â€¦";
            root.appendChild(dots);
          }
          root.appendChild(pageBtn(totalPagesLocal));
        }

        const next = document.createElement("button");
        next.className = "pageBtn";
        next.textContent = "æ¬¡ã¸ â†’";
        next.disabled = currentPage >= totalPagesLocal;
        next.onclick = ()=>{ currentPage++; renderList(); };
        root.appendChild(next);
      };

      const pageBtn = (p)=>{
        const b = document.createElement("button");
        b.className = "pageBtn" + (p===currentPage ? " active" : "");
        b.textContent = String(p);
        b.onclick = ()=>{ currentPage = p; renderList(); window.scrollTo({top:0, behavior:"smooth"}); };
        return b;
      };

      make("pagerTop");
      make("pagerBottom");
    }

    function renderList(){
      filteredSorted = getFilteredSorted();

      const total = filteredSorted.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.max(1, Math.min(currentPage, totalPages));

      renderPager(total);

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageItems = filteredSorted.slice(start, end);

      const box = document.getElementById("list");
      box.innerHTML = "";

      if(!pageItems.length){
        box.innerHTML = `<div class="card"><div class="muted">è©²å½“ã™ã‚‹è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
        return;
      }

      pageItems.forEach(q=>{
        const d = q.data || {};
        const el = document.createElement("div");
        el.className = "card";

        const solved = d.bestAnswerId
          ? `<span class="pill">ğŸ†è§£æ±ºæ¸ˆ</span>`
          : `<span class="pill">ğŸŸ¡æœªè§£æ±º</span>`;

        const snippet = esc((d.body || "").trim());

        el.innerHTML = `
          <a href="q.html?id=${q.id}" style="font-weight:800;font-size:16px">
            ${esc(d.title||"(ç„¡é¡Œ)")}
          </a>

          <!-- æœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ2ã€œ3è¡Œï¼‰ -->
          <div class="snippet">${snippet || "<span class='muted'>ï¼ˆæœ¬æ–‡ãªã—ï¼‰</span>"}</div>

          <div class="qmeta">
            å›ç­”:${d.answerCount||0}ã€€
            å…±æ„Ÿ:${d.likeCount||0}
            ${solved}
          </div>
        `;
        box.appendChild(el);
      });
    }

    async function loadNoti(){
      const box = document.getElementById("notiBox");
      box.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

      let items = [];
      try{
        items = await listMyNotifications(30);
      }catch(e){
        console.error(e);
        box.innerHTML = `<span class="muted">é€šçŸ¥ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
        return;
      }

      if(!items.length){
        box.innerHTML = `<span class="muted">é€šçŸ¥ãªã—</span>`;
        return;
      }

      box.innerHTML = "";
      items.forEach(n=>{
        const d = n.data || {};
        const row = document.createElement("div");
        row.style.margin = "8px 0";

        const newTag = d.read ? "" : `<span class="pill new">NEW</span>`;
        const link = d.qid ? `q.html?id=${d.qid}` : "#";

        row.innerHTML = `
          <a href="${link}">ğŸ”” ${esc(d.message || "é€šçŸ¥")}</a>
          ${newTag}
        `;

        row.addEventListener("click", async ()=>{
          try{ await markNotificationRead(n.id); }catch(e){ console.warn(e); }
        });

        box.appendChild(row);
      });
    }

    async function loadAll(){
      const res = await listQuestions();
      all = res.filter(q => !q.data?.deleted);

      // ä¸Šéƒ¨3BOXã¯å…¨ä½“ã‹ã‚‰ä½œã‚‹ï¼ˆä¸€è¦§ã®çµã‚Šè¾¼ã¿ã¨ã¯ç‹¬ç«‹ï¼‰
      renderTopBoxes();

      // åˆæœŸè¡¨ç¤ºï¼š1ãƒšãƒ¼ã‚¸ç›®
      currentPage = 1;
      renderList();

      // é€šçŸ¥
      loadNoti();
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      loadAll();

      document.getElementById("sortMode")?.addEventListener("change", ()=>{
        currentPage = 1;
        renderList();
      });

      document.getElementById("searchInput")?.addEventListener("input", ()=>{
        currentPage = 1;
        renderList();
      });

      document.getElementById("clearBtn")?.addEventListener("click", ()=>{
        document.getElementById("searchInput").value = "";
        document.getElementById("sortMode").value = "like";
        currentPage = 1;
        renderList();
      });

      document.getElementById("reloadNotiBtn")?.addEventListener("click", loadNoti);
    });
  </script>
</body>
</html>
