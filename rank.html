<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ランキング | 整形相談室</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="wrap">
    <h1>ランキング</h1>
    <nav>
      <a href="index.html">一覧</a>
      <a href="ask.html">質問する</a>
    </nav>
  </div>
</header>

<main>
  <div class="card">
    <div class="notice">
      <b>ランキングについて：</b>
      ベスト回答数 / 参考になった数 / 回答数を集計しています。<br>
      ※匿名のままでも参加できますが、端末変更などでIDが変わることがあります。ガチ勢はGoogleログイン推奨。<br>
      ※Xは「回答投稿時に入力されたもの」を自動で表示します（代表1つ）。
    </div>
    <div>
  <label>表示対象</label>
  <select id="who">
    <option value="gx" selected>Google or X のみ（匿名除外）</option>
    <option value="g">Googleログインのみ</option>
    <option value="x">X表示のみ</option>
  </select>
</div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>表示</label>
        <select id="mode">
          <option value="mix" selected>総合（回答＋ベスト＋参考）</option>
          <option value="best">ベスト回答数</option>
          <option value="help">参考になった合計</option>
          <option value="ans">回答数</option>
        </select>
      </div>
      <div>
        <label>サンプル数（直近回答から）</label>
        <select id="sample">
          <option value="200">200</option>
          <option value="500" selected>500</option>
          <option value="1000">1000</option>
        </select>
      </div>
    </div>

    <div class="muted" style="margin-top:8px">
      総合スコア：回答×1 + ベスト×5 + 参考×0.2（調整可）
    </div>

    <div id="status" class="muted" style="margin-top:10px">読み込み中…</div>
    <div id="list" style="margin-top:10px"></div>
  </div>
</main>

<script type="module">
  import { getLeaderboardSample, esc } from "./app.js";

  function renderTable(rows, mode){
    const label =
      mode==="best" ? "ベスト" :
      mode==="help" ? "参考合計" :
      "回答数";

    return `
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:8px">順位</th>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:8px">表示名</th>
            <th style="text-align:right;border-bottom:1px solid #eee;padding:8px">${label}</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td style="padding:8px;border-bottom:1px solid #f1f1f1">${i+1}</td>
              <td style="padding:8px;border-bottom:1px solid #f1f1f1">${r.name}</td>
              <td style="padding:8px;border-bottom:1px solid #f1f1f1;text-align:right"><b>${r.value}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

   function pickDisplayName(u){
  // Xがあればリンク（@xxxx → https://x.com/xxxx）
  if(u.x){
    const x = String(u.x).trim();
    if(x.startsWith("@")){
      const name = x.slice(1);
      const safeName = esc(name);
      return `<a href="https://x.com/${safeName}" target="_blank" rel="noopener">
                <span class="kbd">${esc(x)}</span>
              </a>`;
    }
    // 万一URLで入ってた場合もリンクにする
    if(/^https?:\/\//.test(x)){
      return `<a href="${esc(x)}" target="_blank" rel="noopener">
                <span class="kbd">X</span>
              </a>`;
    }
    // それ以外は表示だけ
    return `<span class="kbd">${esc(x)}</span>`;
  }

  // Xが無いならUID短縮
  return `<span class="kbd">${esc(u.uid.slice(0,10))}</span>`;
}

  async function load(){
    const statusEl = document.getElementById("status");
    const mode = document.getElementById("mode").value;
    const sample = Number(document.getElementById("sample").value);
    const who = document.getElementById("who").value; // gx / g / x

    statusEl.textContent = "集計中…";

    const answers = await getLeaderboardSample(sample);

    // uidごとに集計
    // usersMap: uid -> { uid, best, help, ans, isGoogle, x }
    const usersMap = new Map();

    for(const a of answers){
      const d = a.data || {};
      if(d.deleted) continue;

      const uid = d.ownerUid;
      if(!uid) continue;

      const cur = usersMap.get(uid) || {
        uid,
        best: 0,
        help: 0,
        ans: 0,
        isGoogle: false,  // answersに保存されたフラグ（今後の回答から）
        x: ""             // @handle
      };

      // 回答の集計
      cur.ans += 1;
      cur.help += (d.helpfulCount || 0);
      if(d.best) cur.best += 1;

      // Google判定（answersに入ってる前提。無い過去データは false 扱い）
      if(d.isGoogleUser === true) cur.isGoogle = true;

      // X判定（1回でも書いたら保持）
      const xh = String(d.xHandle || "").trim();
      if(xh && !cur.x) cur.x = xh;

      usersMap.set(uid, cur);
    }

    // 表示対象フィルタ（匿名を隠す）
    const eligible = (u)=>{
      const hasX = !!u.x;
      const isG  = (u.isGoogle === true);
      if(who === "g") return isG;
      if(who === "x") return hasX;
      return (isG || hasX); // gx
    };

    // rows生成
    const rows = [...usersMap.values()]
      .filter(u => eligible(u))
      .map(u => {
        const value =
          mode==="best" ? u.best :
          mode==="help" ? u.help :
          u.ans;

        return {
          uid: u.uid,
          name: pickDisplayName(u),
          value
        };
      })
      .filter(r => r.value > 0)
      .sort((a,b)=> b.value - a.value)
      .slice(0,50);

    statusEl.textContent = rows.length
      ? ""
      : "まだデータがありません（条件に合う回答者がいない / サンプル数が少ない可能性）";

    document.getElementById("list").innerHTML = rows.length ? renderTable(rows, mode) : "";
  }

  ["mode","sample","who"].forEach(id=>{
    document.getElementById(id).addEventListener("change", load);
  });

  load().catch(e=>{
    console.error(e);
    const code = e?.code ? `(${e.code}) ` : "";
    const msg  = e?.message ? e.message : String(e);
    document.getElementById("status").textContent = `読み込みに失敗: ${code}${msg}`;
  });
</script>

</body>
</html>
