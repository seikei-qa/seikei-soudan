<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
 <title id="pageTitle">è³ªå•è©³ç´° | æ•´å½¢ç›¸è«‡å®¤</title>
<meta name="description" id="metaDesc" content="æ•´å½¢ã®ä½“é¨“è«‡ã‚„ä¸å®‰ã‚’ç›¸è«‡ã§ãã‚‹Q&Aã§ã™ã€‚">

  <link rel="stylesheet" href="./style.css"/>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">æ•´å½¢ç›¸è«‡å®¤</div>
      <div class="tabs">
        <a class="tab" href="./index.html">ä¸€è¦§</a>
        <a class="tab" href="./ask.html">è³ªå•ã™ã‚‹</a>
        <a class="tab" href="./rank.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
      </div>
    </div>

    <div id="maintenanceBox" class="card" style="display:none;margin-top:12px"></div>

    <!-- è³ªå• -->
    <div id="qCard" class="card" style="margin-top:12px">
      <div class="muted small">è³ªå•</div>
      <h1 id="qTitle" style="margin:6px 0 8px 0; font-size:22px; line-height:1.2"></h1>
      <div class="row" id="qOwnerBtns" style="gap:8px;flex-wrap:wrap;margin-top:8px;display:none">
  <button id="qEditBtn" class="btn ghost">è³ªå•ã‚’ç·¨é›†</button>
  <button id="qDelBtn" class="btn ghost danger">è³ªå•ã‚’å‰Šé™¤</button>
</div>

 
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button id="copyUrlBtn" class="btn ghost">URLã‚³ãƒ”ãƒ¼</button>
        <button id="watchBtn" class="btn ghost">â˜† ä¿å­˜</button>
        <button id="likeBtn" class="btn ghost">å…±æ„Ÿ</button>
        <button id="loginBtn" class="btn ghost" style="width:auto">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</button>
      </div>

      <div id="qMeta" class="muted small" style="margin-top:10px"></div>
      <div id="qBody" style="white-space:pre-wrap;margin-top:10px"></div>
      <div id="qDanger" class="danger small" style="display:none;margin-top:10px"></div>
      <div id="qEditBox" class="card" style="display:none;margin-top:12px">
  <div class="muted small">è³ªå•ã‚’ç·¨é›†ï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰</div>

  <div class="muted small" style="margin-top:8px">ã‚¿ã‚¤ãƒˆãƒ«</div>
  <input id="qEditTitle" class="input" style="width:100%" />

  <div class="muted small" style="margin-top:8px">æœ¬æ–‡</div>
  <textarea id="qEditBody" class="textarea" style="min-height:120px"></textarea>

  <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
    <button id="qEditSaveBtn" class="btn primary">ä¿å­˜</button>
    <button id="qEditCancelBtn" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <div id="qEditWarn" class="danger small" style="display:none;margin-top:8px"></div>
</div>

    </div>

    <!-- å›ç­”æŠ•ç¨¿ -->
    <div id="answerComposer" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:700">å›ç­”ã™ã‚‹</div>
        <div class="muted small">ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</div>
      </div>

      <textarea id="ansTa" class="textarea" placeholder="å›ç­”ã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>

      <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
        <input id="ansX" class="input" style="flex:1;min-width:220px" placeholder="å›ç­”è€…ã®Xï¼ˆä»»æ„ï¼‰ä¾‹ï¼š@xxxx / https://x.com/xxxx">
        <button id="postAnsBtn" class="btn primary">å›ç­”ã‚’æŠ•ç¨¿</button>
      </div>
      <div id="ansWarn" class="danger small" style="display:none;margin-top:8px"></div>
    </div>

    <!-- ä¸¦ã³æ›¿ãˆ -->
    <div class="card" style="margin-top:12px">
      <div class="muted small" style="margin-bottom:6px">å›ç­”ã®ä¸¦ã³æ›¿ãˆï¼ˆãƒ™ã‚¹ãƒˆã¯å¸¸ã«æœ€ä¸Šéƒ¨ï¼‰</div>
      <select id="answerSortSel" class="select" style="width:100%">
        <option value="helpful">å‚è€ƒã«ãªã£ãŸé †ï¼ˆãŠã™ã™ã‚ï¼‰</option>
        <option value="new">æ–°ã—ã„é †</option>
        <option value="old">å¤ã„é †</option>
      </select>
    </div>

    <!-- å›ç­”ä¸€è¦§ -->
    <div id="answersBox" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:700">å›ç­”ä¸€è¦§</div>
        <div id="ansCount" class="muted small"></div>
      </div>
      <div id="answersInner" style="margin-top:10px"></div>
    </div>

    <!-- é–¢é€£è³ªå• -->
    <div id="relatedBox" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:700">é–¢é€£è³ªå•</div>
        <div id="relCount" class="muted small"></div>
      </div>
      <div id="relatedInner" style="margin-top:10px"></div>
    </div>
  </div>

<script type="module">
  import {
    // auth / util
   db, ensureAnonAuth, currentUid, esc, tokenize, containsDanger, optionalGoogleLogin,

    // maintenance
    getSiteConfig,

    // question
    getQuestion, listQuestions, updateQuestion, softDeleteQuestion,

    toggleWatchQuestion, isWatching,
    toggleLikeQuestion, isLiked,
    copyToClipboard,

    // answers
    listAnswers, addAnswer, updateAnswer, softDeleteAnswer,
    toggleHelpful, isHelpful, setBestAnswer, setThanks,

    // replies
    listReplies, addReply, updateReply, softDeleteReply,

    // reports
    createReport
  } from "./app.js";

  // ========= state =========
 const params = new URLSearchParams(location.search);
const qid =
  params.get("id") ||
  params.get("qid") ||
  params.get("q") ||
  params.get("questionId");
console.log("q.html qid =", qid, "search =", location.search);

  let qObj = null; // {id,data}
  let answerSort = "helpful";

  // ========= dom =========
  const maintenanceBox = document.getElementById("maintenanceBox");
  const qTitle = document.getElementById("qTitle");
  const qMeta  = document.getElementById("qMeta");
  const qBody  = document.getElementById("qBody");
  const qDanger = document.getElementById("qDanger");
  const qOwnerBtns = document.getElementById("qOwnerBtns");
const qEditBtn = document.getElementById("qEditBtn");
const qDelBtn  = document.getElementById("qDelBtn");

const qEditBox = document.getElementById("qEditBox");
const qEditTitle = document.getElementById("qEditTitle");
const qEditBody  = document.getElementById("qEditBody");
const qEditSaveBtn = document.getElementById("qEditSaveBtn");
const qEditCancelBtn = document.getElementById("qEditCancelBtn");
const qEditWarn = document.getElementById("qEditWarn");

  const copyUrlBtn = document.getElementById("copyUrlBtn");
  const watchBtn = document.getElementById("watchBtn");
  const likeBtn = document.getElementById("likeBtn");
  const loginBtn = document.getElementById("loginBtn");

  const ansTa = document.getElementById("ansTa");
  const ansX = document.getElementById("ansX");
  const postAnsBtn = document.getElementById("postAnsBtn");
  const ansWarn = document.getElementById("ansWarn");

  const answerSortSel = document.getElementById("answerSortSel");
  const ansCount = document.getElementById("ansCount");
  const answersInner = document.getElementById("answersInner");

  const relCount = document.getElementById("relCount");
  const relatedInner = document.getElementById("relatedInner");

  // ========= helpers =========
  function fmtTime(ts){
    try{
      if(!ts) return "";
      const d = ts?.toDate ? ts.toDate() : new Date((ts.seconds||0)*1000);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}/${m}/${da} ${hh}:${mm}`;
    }catch{
      return "";
    }
  }

  function showWarn(el, msg){
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block"; el.textContent=msg;
  }

  function parseX(input){
    const s = (input||"").trim();
    if(!s) return "";
    const m = s.match(/(?:x\.com\/|twitter\.com\/)?@?([A-Za-z0-9_]{1,15})/);
    if(m && m[1]) return "@"+m[1];
    if(/^https?:\/\//.test(s)) return s.slice(0,200);
    return s.slice(0,80);
  }

  function xLinkHtml(xh){
    const s = (xh||"").trim();
    if(!s) return "";
    if(s.startsWith("@")){
      const name = s.slice(1);
      return `<a href="https://x.com/${esc(name)}" target="_blank" rel="noopener">${esc(s)}</a>`;
    }
    if(/^https?:\/\//.test(s)){
      return `<a href="${esc(s)}" target="_blank" rel="noopener">X</a>`;
    }
    return esc(s);
  }

  // ========= maintenance =========
   async function checkMaintenance(){
    const cfg = await getSiteConfig();
    if(cfg?.maintenance){
      maintenanceBox.style.display = "block";
      maintenanceBox.innerHTML = `
        <div style="font-weight:700">ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</div>
        <div class="muted small" style="margin-top:6px">${esc(cfg.message||"ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„")}</div>
      `;
    }else{
      maintenanceBox.style.display = "none";
      maintenanceBox.innerHTML = "";
    }
  }

  // ========= header UI =========
  async function refreshLikeWatch(){
    try{
      const w = await isWatching(qid);
      watchBtn.textContent = w ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
    }catch{}
    try{
      const l = await isLiked(qid);
      likeBtn.textContent = l ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";
    }catch{}
  }

  // ========= question =========
  async function renderQuestion (){
    if(!qid){
      qTitle.textContent = "URLãŒä¸æ­£ã§ã™";
      qMeta.textContent = "";
      qBody.textContent = "";
      return;
    }

    qObj = await getQuestion(qid);
    if(!qObj){
      qTitle.textContent = "è³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      qMeta.textContent = "";
      qBody.textContent = "";
      return;
    }

    const d = qObj.data || {};
    qTitle.textContent = d.title || "(ç„¡é¡Œ)";
    qBody.textContent = d.body || "";
    // ===== SEOï¼ˆtitle + descriptionï¼‰=====
const t = (d.title || "(ç„¡é¡Œ)").trim();
const b = (d.body || "").replace(/\s+/g, " ").trim();

const titleEl = document.getElementById("pageTitle");
if(titleEl) titleEl.textContent = `${t} | æ•´å½¢ç›¸è«‡å®¤`;

const meta = document.getElementById("metaDesc");
if(meta){
  const desc = (b ? b : t).slice(0, 120);
  meta.setAttribute("content", desc);
}

    const created = fmtTime(d.createdAt);
    const likeC = d.likeCount || 0;
    const ansC  = d.answerCount || 0;
    const status = d.bestAnswerId ? "ğŸŸ¡ è§£æ±º" : "ğŸŸ¡ æœªè§£æ±º";

    qMeta.textContent = `å…±æ„Ÿ:${likeC} / å›ç­”:${ansC} / ä½œæˆ:${created} / ${status}`;

    // å±é™ºãƒ¯ãƒ¼ãƒ‰æ³¨æ„ï¼ˆè¡¨ç¤ºã ã‘ï¼‰
    const danger = containsDanger((d.title||"") + "\n" + (d.body||""));
    showWarn(qDanger, danger ? "æ³¨æ„ï¼šæ–­å®šãƒ»æ”»æ’ƒãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¡¨ç¾ã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã€‚" : "");
    const isOwner = d.ownerUid && currentUid && d.ownerUid === currentUid;
if(qOwnerBtns){
  qOwnerBtns.style.display = isOwner ? "flex" : "none";
}

    await refreshLikeWatch();
  }

  // ========= replies =========
  async function renderReplies(aid){
    const root = document.getElementById("replyList_"+aid);
    if(!root) return;

    root.innerHTML = `<span class="muted">èª­ã¿è¾¼ã¿ä¸­...</span>`;

    let list = [];
    try{
      list = await listReplies(qid, aid);
    }catch(e){
      root.innerHTML = `<span class="danger small">è¿”ä¿¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
      console.error(e);
      return;
    }

    const live = (list||[]).filter(r => !r.data?.deleted);
    if(!live.length){
      root.innerHTML = `<span class="muted">è¿”ä¿¡ãªã—</span>`;
      return;
    }

    root.innerHTML = live.map(r=>{
      const d = r.data || {};
      const mine = d.ownerUid && currentUid && d.ownerUid === currentUid;

      return `
        <div class="card" style="margin:8px 0">
          <div class="row" style="justify-content:space-between;gap:8px;flex-wrap:wrap">
            <div class="muted small">${esc(fmtTime(d.createdAt))}</div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" data-ract="rreport" data-aid="${aid}" data-rid="${r.id}">é€šå ±</button>
              ${mine ? `<button class="btn ghost" data-ract="redit" data-aid="${aid}" data-rid="${r.id}">ç·¨é›†</button>` : ``}
              ${mine ? `<button class="btn ghost danger" data-ract="rdel" data-aid="${aid}" data-rid="${r.id}">å‰Šé™¤</button>` : ``}
            </div>
          </div>

          <div id="rb_${aid}_${r.id}" style="white-space:pre-wrap;margin-top:6px">${esc(d.body||"")}</div>

          <div id="re_${aid}_${r.id}" class="card" style="display:none;margin-top:10px">
            <div class="muted small">è¿”ä¿¡ã‚’ç·¨é›†</div>
            <textarea class="textarea" id="reTa_${aid}_${r.id}" style="min-height:70px"></textarea>
            <div class="row" style="gap:8px;margin-top:6px">
              <button class="btn primary" data-ract="rsave" data-aid="${aid}" data-rid="${r.id}">ä¿å­˜</button>
              <button class="btn ghost" data-ract="rcancel" data-aid="${aid}" data-rid="${r.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="danger small" id="reWarn_${aid}_${r.id}" style="display:none;margin-top:6px"></div>
          </div>
        </div>
      `;
    }).join("");

    // è¿”ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    root.querySelectorAll("button[data-ract]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.dataset.ract;
        const rid = btn.dataset.rid;

        if(act === "rreport"){
          const reason = prompt("é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰");
          try{
            await createReport({ type:"reply", qid, aid, rid, reason: reason||"" });
            alert("é€šå ±ã—ã¾ã—ãŸã€‚");
          }catch(e){
            alert("é€šå ±ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(e);
          }
          return;
        }

        if(act === "redit"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          const ta  = document.getElementById(`reTa_${aid}_${rid}`);
          const body = document.getElementById(`rb_${aid}_${rid}`);
          if(box && ta){
            box.style.display = "block";
            ta.value = body ? body.textContent : "";
          }
          return;
        }

        if(act === "rcancel"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          if(box) box.style.display = "none";
          return;
        }

        if(act === "rsave"){
          const ta = document.getElementById(`reTa_${aid}_${rid}`);
          const warn = document.getElementById(`reWarn_${aid}_${rid}`);
          const text = (ta?.value||"").trim();
          if(!text){
            warn.style.display="block"; warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
            return;
          }
          if(text.length > 800){
            warn.style.display="block"; warn.textContent="è¿”ä¿¡ã¯800æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
            return;
          }
          try{
            await updateReply(qid, aid, rid, { body:text });
            warn.style.display="none"; warn.textContent="";
            await renderReplies(aid);
          }catch(e){
            warn.style.display="block";
            warn.textContent="æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰";
            console.error(e);
          }
          return;
        }

        if(act === "rdel"){
          if(!confirm("ã“ã®è¿”ä¿¡ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await softDeleteReply(qid, aid, rid);
            await renderReplies(aid);
          }catch(e){
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰");
            console.error(e);
          }
          return;
        }
      });
    });
  }

  function renderReplyComposer(aid){
    const box = document.getElementById("replyComposer_"+aid);
    if(!box) return;

    // â˜…é‡è¦ï¼šè¿”ä¿¡å…¥åŠ›æ¬„ã¯ã€Œè¿”ä¿¡ä¸€è¦§ã®ä¸‹ã€ã«å›ºå®šï¼ˆã‚ãªãŸã®è¦æœ›ï¼‰
    box.innerHTML = `
      <div class="card">
        <textarea class="textarea" id="rpTa_${aid}" style="min-height:70px" placeholder="å›ç­”ã¸ã®è¿”ä¿¡ã‚’æ›¸ãã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰"></textarea>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn primary" data-rp="post" data-aid="${aid}">è¿”ä¿¡ã‚’æŠ•ç¨¿</button>
        </div>
        <div class="danger small" id="rpWarn_${aid}" style="display:none;margin-top:6px"></div>
      </div>
    `;

    const btn = box.querySelector(`button[data-rp="post"][data-aid="${aid}"]`);
    btn.addEventListener("click", async ()=>{
      const ta = document.getElementById("rpTa_"+aid);
      const warn = document.getElementById("rpWarn_"+aid);
      const text = (ta?.value||"").trim();

      if(!text){
        warn.style.display="block"; warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
        return;
      }
      if(text.length > 800){
        warn.style.display="block"; warn.textContent="è¿”ä¿¡ã¯800æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      try{
        await addReply(qid, aid, { body:text });
        ta.value = "";
        warn.style.display="none"; warn.textContent="";
        await renderReplies(aid);
      }catch(e){
        warn.style.display="block"; warn.textContent="æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(e);
      }
    });
  }

  // ========= answers =========
  async function renderAnswers(){
    answersInner.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;

    let list = [];
    try{
      list = await listAnswers(qid);
    }catch(e){
      answersInner.innerHTML = `<div class="danger small">å›ç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
      console.error(e);
      return;
    }

    const live = (list||[]).filter(a => !a.data?.deleted);
    const answersMap = new Map(live.map(x => [x.id, x.data || {}]));

    ansCount.textContent = `(${live.length}ä»¶)`;

    if(!live.length){
      answersInner.innerHTML = `<div class="muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    // ãƒ™ã‚¹ãƒˆå…ˆé ­å›ºå®š
    const best = live.find(a => a.data?.best);
    let others = live.filter(a => !a.data?.best);

    // ä¸¦ã³æ›¿ãˆï¼ˆãƒ™ã‚¹ãƒˆä»¥å¤–ï¼‰
    if(answerSort === "helpful"){
      others.sort((a,b)=>(b.data?.helpfulCount||0)-(a.data?.helpfulCount||0));
    }else if(answerSort === "new"){
      others.sort((a,b)=>(b.data?.createdAt?.seconds||0)-(a.data?.createdAt?.seconds||0));
    }else if(answerSort === "old"){
      others.sort((a,b)=>(a.data?.createdAt?.seconds||0)-(b.data?.createdAt?.seconds||0));
    }

    const final = best ? [best, ...others] : others;
    answersInner.innerHTML = "";

    const qOwner = qObj?.data?.ownerUid || null; // è³ªå•è€…UID
    const isQuestionOwner = qOwner && currentUid && qOwner === currentUid;

    for(const a of final){
      const d = a.data || {};
      const mine = d.ownerUid && currentUid && d.ownerUid === currentUid;

      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.margin = "10px 0";

      const xHtml = d.xHandle ? `<span class="pill">X:${xLinkHtml(d.xHandle)}</span>` : "";

      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <b>${d.best ? "ğŸ†ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼" : "å›ç­”"}</b>
            <span class="muted small" style="margin-left:8px">${esc(fmtTime(d.createdAt))}</span>
          </div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <span class="pill">å‚è€ƒ:${esc(d.helpfulCount||0)}</span>
            ${xHtml}
          </div>
        </div>

        <div class="ansBody" style="white-space:pre-wrap;margin-top:8px">${esc(d.body||"")}</div>
        ${(d.thanksText && String(d.thanksText).trim())
  ? `
    <div class="card" style="margin-top:10px;padding:10px">
      <div class="muted small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆ</div>
      <div style="white-space:pre-wrap;margin-top:6px">${esc(d.thanksText)}</div>
      ${d.thanksAt ? `<div class="muted small" style="margin-top:6px">${esc(fmtTime(d.thanksAt))}</div>` : ``}
    </div>
  `
  : ``}

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="btn ghost" data-act="helpful" data-aid="${a.id}">å‚è€ƒã«ãªã£ãŸ</button>
          <button class="btn ghost" data-act="report" data-aid="${a.id}">é€šå ±</button>

          ${isQuestionOwner && !d.best ? `<button class="btn ghost" data-act="best" data-aid="${a.id}">ãƒ™ã‚¹ãƒˆã«ã™ã‚‹</button>` : ``}
          ${isQuestionOwner ? `<button class="btn ghost" data-act="thanks" data-aid="${a.id}">ãŠç¤¼</button>` : ``}

          ${mine ? `<button class="btn ghost" data-act="edit" data-aid="${a.id}">ç·¨é›†</button>` : ``}
          ${mine ? `<button class="btn ghost danger" data-act="del" data-aid="${a.id}">å‰Šé™¤</button>` : ``}
        </div>

        <div id="thBox_${a.id}" class="card" style="display:none;margin-top:10px">
          <div class="muted small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè³ªå•è€…ã®ã¿ï¼‰</div>
          <textarea class="textarea" id="thTa_${a.id}" style="min-height:70px" placeholder="ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
          <div class="row" style="gap:8px;margin-top:6px">
            <button class="btn primary" data-act="thanksSave" data-aid="${a.id}">ä¿å­˜</button>
            <button class="btn ghost" data-act="thanksCancel" data-aid="${a.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div class="danger small" id="thWarn_${a.id}" style="display:none;margin-top:6px"></div>
        </div>

        <div id="edBox_${a.id}" class="card" style="display:none;margin-top:10px">
          <div class="muted small">å›ç­”ã‚’ç·¨é›†</div>
          <textarea class="textarea" id="edTa_${a.id}" style="min-height:90px"></textarea>
          <div class="row" style="gap:8px;margin-top:6px">
            <button class="btn primary" data-act="editSave" data-aid="${a.id}">ä¿å­˜</button>
            <button class="btn ghost" data-act="editCancel" data-aid="${a.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div class="danger small" id="edWarn_${a.id}" style="display:none;margin-top:6px"></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted small">è¿”ä¿¡</div>
          <div id="replyList_${a.id}" style="margin-top:8px"></div>
          <div id="replyComposer_${a.id}" style="margin-top:10px"></div>
        </div>
      `;

      answersInner.appendChild(wrap);

      // helpfulæ¸ˆã¿åæ˜ 
      try{
        const done = await isHelpful(qid, a.id);
        if(done){
          const b = wrap.querySelector(`[data-act="helpful"][data-aid="${a.id}"]`);
          if(b) b.textContent = "å‚è€ƒæ¸ˆã¿";
        }
      }catch{}

      // è¿”ä¿¡æç”» & å…¥åŠ›æ¬„
      await renderReplies(a.id);
      renderReplyComposer(a.id);

      // å›ç­”ã®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
      wrap.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.dataset.act;
          const aid = btn.dataset.aid;

          if(act === "helpful"){
            try{
              const r = await toggleHelpful(qid, aid);
              btn.textContent = r.helpful ? "å‚è€ƒæ¸ˆã¿" : "å‚è€ƒã«ãªã£ãŸ";
              await renderAnswers();
              await renderQuestion(); // å›ç­”æ•°/è§£æ±ºè¡¨ç¤ºæ›´æ–°
            }catch(e){
              alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
              console.error(e);
            }
            return;
          }

          if(act === "report"){
            const reason = prompt("é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰");
            try{
              await createReport({ type:"answer", qid, aid, reason: reason||"" });
              alert("é€šå ±ã—ã¾ã—ãŸã€‚");
            }catch(e){
              alert("é€šå ±ã«å¤±æ•—ã—ã¾ã—ãŸ");
              console.error(e);
            }
            return;
          }

          if(act === "best"){
            if(!confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try{
              await setBestAnswer(qid, aid);
              await renderQuestion();
              await renderAnswers();
            }catch(e){
              alert("ãƒ™ã‚¹ãƒˆè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³ªå•è€…ã®ã¿ï¼‰");
              console.error(e);
            }
            return;
          }

       if(act === "thanks"){
  const box = document.getElementById(`thBox_${aid}`);
  if(box){
    const next = (box.style.display==="none" ? "block" : "none");
    box.style.display = next;

    // æ—¢ã«ãŠç¤¼ãŒã‚ã‚‹ãªã‚‰ textarea ã«å…¥ã‚Œã‚‹ï¼ˆç©ºã®ã¨ãã ã‘ï¼‰
    if(next === "block"){
      const ta = document.getElementById(`thTa_${aid}`);
      if(ta && !ta.value){
        const ad = answersMap.get(aid) || {};
        ta.value = (ad.thanksText || "");
      }
    }
  }
  return;
}


          if(act === "thanksCancel"){
            const box = document.getElementById(`thBox_${aid}`);
            if(box) box.style.display = "none";
            return;
          }

          if(act === "thanksSave"){
            const ta = document.getElementById(`thTa_${aid}`);
            const warn = document.getElementById(`thWarn_${aid}`);
            const text = (ta?.value||"").trim();
            if(text.length > 400){
              warn.style.display="block"; warn.textContent="ãŠç¤¼ã¯400æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
              return;
            }
            try{
              await setThanks(qid, aid, text);
              warn.style.display="none"; warn.textContent="";
              alert("ä¿å­˜ã—ã¾ã—ãŸ");
              await renderAnswers();
            }catch(e){
              warn.style.display="block";
              warn.textContent="ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³ªå•è€…ã®ã¿ï¼‰";
              console.error(e);
            }
            return;
          }

          if(act === "edit"){
            const box = document.getElementById(`edBox_${aid}`);
            const ta  = document.getElementById(`edTa_${aid}`);
            const bodyEl = wrap.querySelector(".ansBody");
            if(box && ta){
              box.style.display = (box.style.display==="none" ? "block" : "none");
              ta.value = bodyEl ? bodyEl.textContent : "";
            }
            return;
          }

          if(act === "editCancel"){
            const box = document.getElementById(`edBox_${aid}`);
            if(box) box.style.display="none";
            return;
          }

          if(act === "editSave"){
            const ta = document.getElementById(`edTa_${aid}`);
            const warn = document.getElementById(`edWarn_${aid}`);
            const text = (ta?.value||"").trim();
            if(!text){
              warn.style.display="block"; warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
              return;
            }
            if(text.length > 2000){
              warn.style.display="block"; warn.textContent="æœ¬æ–‡ã¯2000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
              return;
            }
            try{
              await updateAnswer(qid, aid, { body:text });
              warn.style.display="none"; warn.textContent="";
              alert("æ›´æ–°ã—ã¾ã—ãŸ");
              await renderAnswers();
            }catch(e){
              warn.style.display="block";
              warn.textContent="æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰";
              console.error(e);
            }
            return;
          }

          if(act === "del"){
            if(!confirm("ã“ã®å›ç­”ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try{
              await softDeleteAnswer(qid, aid);
              await renderQuestion();
              await renderAnswers();
            }catch(e){
              alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰");
              console.error(e);
            }
          }
        });
      });
    }
  }

  
// ===== é–¢é€£è³ªå•ï¼ˆgetDocsã‚’ä½¿ã‚ãªã„ç‰ˆï¼‰=====
async function renderRelated(){
  const listEl  = document.getElementById("relatedInner");
  const countEl = document.getElementById("relCount");
  if(!listEl) return;

  listEl.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;

  try{
    // ä»Šè¦‹ã¦ã‚‹è³ªå•ï¼ˆã‚ãªãŸã®å¤‰æ•°åã¯ qObjï¼‰
    const me = (qObj || {}).data || {};
    const meTitle = me.title || "";
    const meBody  = me.body || "";
    const meCat   = me.category || "";
    const meTags  = Array.isArray(me.tags) ? me.tags : [];

    const seed = `${meTitle} ${meBody} ${meTags.join(" ")}`;
    const meTokens = tokenize(seed).slice(0, 20);

    // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šFirestore SDKã‚’ç›´æ¥å©ã‹ãš app.js çµŒç”±ã§å–ã‚‹
    const all = await listQuestions();

    // ã‚¹ã‚³ã‚¢ä»˜ã‘
    const scored = (all || [])
      .filter(x => x.id !== qid)
      .filter(x => !(x.data || {}).deleted)
      .map(x => {
        const d = x.data || {};
        const title = d.title || "";
        const body  = d.body  || "";
        const cat   = d.category || "";
        const tags  = Array.isArray(d.tags) ? d.tags : [];

        const hayTokens = tokenize(`${title} ${body} ${tags.join(" ")}`);

        let score = 0;
        for(const t of meTokens){
          if(hayTokens.includes(t)) score += 1;
        }
        if(meCat && cat && meCat === cat) score += 5;

        if(meTags.length && tags.length){
          const set = new Set(tags);
          let hit = 0;
          for(const tg of meTags) if(set.has(tg)) hit++;
          score += hit * 2;
        }

        const createdAt = d.createdAt?.seconds || 0;
        return { id: x.id, d, score, createdAt };
      });

    // é–¢é€£åº¦ â†’ æ–°ã—ã•
    scored.sort((a,b)=>{
      if(b.score !== a.score) return b.score - a.score;
      return b.createdAt - a.createdAt;
    });

    // ã¾ãšé–¢é€£ï¼ˆscore>0ï¼‰ã‹ã‚‰æœ€å¤§8ä»¶
    let picks = scored.filter(x => x.score > 0).slice(0, 8);

    // 0ä»¶ãªã‚‰æœ€æ–°8ä»¶ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if(picks.length === 0){
      picks = scored
        .sort((a,b)=>b.createdAt - a.createdAt)
        .slice(0, 8);
    }

    if(countEl) countEl.textContent = `${picks.length}ä»¶`;

    if(picks.length === 0){
      listEl.innerHTML = `<div class="muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    listEl.innerHTML = picks.map(x=>{
      const d = x.d || {};
      const t = esc(d.title || "(ç„¡é¡Œ)");
      const b = (d.body || "").trim();
      const snippet = esc(b.slice(0, 90)) + (b.length > 90 ? "â€¦" : "");
      const like = Number(d.likeCount || 0);
      const ans  = Number(d.answerCount || 0);

      return `
        <a class="card" href="./q.html?id=${encodeURIComponent(x.id)}"
           style="display:block;text-decoration:none;color:inherit;margin:8px 0">
          <div style="font-weight:700">${t}</div>
          <div class="muted small" style="margin-top:4px">${snippet}</div>
          <div class="muted small" style="margin-top:6px">${like}å…±æ„Ÿ / ${ans}å›ç­”</div>
        </a>
      `;
    }).join("");

  }catch(e){
    console.error(e);
    listEl.innerHTML = `<div class="danger small">é–¢é€£è³ªå•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
  }
}


  // ========= boot =========
  async function boot(){
    await ensureAnonAuth();
    await checkMaintenance();

    if(!qid){
      qTitle.textContent = "URLãŒä¸æ­£ã§ã™";
      return;
    }

    // sort
    answerSortSel.value = answerSort;
    answerSortSel.addEventListener("change", async ()=>{
      answerSort = answerSortSel.value;
      await renderAnswers();
    });

    // header btns
    copyUrlBtn.addEventListener("click", async ()=>{
      await copyToClipboard(location.href);
      alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    });

    watchBtn.addEventListener("click", async ()=>{
      try{
        const r = await toggleWatchQuestion(qid);
        watchBtn.textContent = r.watching ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
      }catch(e){
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(e);
      }
    });

    likeBtn.addEventListener("click", async ()=>{
      try{
        const r = await toggleLikeQuestion(qid);
        likeBtn.textContent = r.liked ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";
        await renderQuestion();
      }catch(e){
        alert("å…±æ„Ÿã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(e);
      }
    });

    loginBtn.addEventListener("click", async ()=>{
      const r = await optionalGoogleLogin();
      if(r.ok) alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆä»»æ„ï¼‰");
      else alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + (r.error||""));
    });
    // ===== è³ªå•ï¼šç·¨é›†UI é–‹é–‰ =====
qEditBtn?.addEventListener("click", ()=>{
  if(!qObj?.data) return;

  // warnæ¶ˆã™
  qEditWarn.style.display = "none";
  qEditWarn.textContent = "";

  // ç¾åœ¨å€¤ã‚’å…¥ã‚Œã‚‹
  qEditTitle.value = qObj.data.title || "";
  qEditBody.value  = qObj.data.body  || "";

  // è¡¨ç¤ºåˆ‡æ›¿
  qEditBox.style.display = (qEditBox.style.display === "none" ? "block" : "none");
});

qEditCancelBtn?.addEventListener("click", ()=>{
  qEditBox.style.display = "none";
});

// ===== è³ªå•ï¼šä¿å­˜ =====
qEditSaveBtn?.addEventListener("click", async ()=>{
  qEditWarn.style.display = "none";
  qEditWarn.textContent = "";

  const title = (qEditTitle.value||"").trim();
  const body  = (qEditBody.value||"").trim();

  if(!title || !body){
    qEditWarn.style.display = "block";
    qEditWarn.textContent = "ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã¯å¿…é ˆã§ã™ã€‚";
    return;
  }
  if(title.length > 80){
    qEditWarn.style.display = "block";
    qEditWarn.textContent = "ã‚¿ã‚¤ãƒˆãƒ«ã¯80æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  if(body.length > 5000){
    qEditWarn.style.display = "block";
    qEditWarn.textContent = "æœ¬æ–‡ã¯5000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  if(containsDanger(title + "\n" + body)){
    qEditWarn.style.display = "block";
    qEditWarn.textContent = "æ³¨æ„ï¼šæ–­å®šãƒ»æ”»æ’ƒãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¡¨ç¾ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  try{
    await updateQuestion(qid, { title, body });
    qEditBox.style.display = "none";
    await renderQuestion();
    await renderRelated();
    alert("æ›´æ–°ã—ã¾ã—ãŸ");
  }catch(e){
    console.error(e);
    qEditWarn.style.display = "block";
    qEditWarn.textContent = "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰";
  }
});

// ===== è³ªå•ï¼šå‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰=====
qDelBtn?.addEventListener("click", async ()=>{
  if(!confirm("ã“ã®è³ªå•ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
  try{
    await softDeleteQuestion(qid);
    alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    location.href = "./index.html";
  }catch(e){
    console.error(e);
    alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰");
  }
});

    postAnsBtn.addEventListener("click", async ()=>{
      showWarn(ansWarn, "");
      const body = (ansTa.value||"").trim();
      const xh = parseX(ansX.value);

      if(!body){
        showWarn(ansWarn, "æœ¬æ–‡ãŒç©ºã§ã™ã€‚");
        return;
      }
      if(body.length > 2000){
        showWarn(ansWarn, "æœ¬æ–‡ã¯2000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if(containsDanger(body)){
        showWarn(ansWarn, "æ³¨æ„ï¼šæ–­å®šãƒ»æ”»æ’ƒãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¡¨ç¾ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      try{
        await addAnswer(qid, { body, xHandle:xh });
        ansTa.value = "";
        ansX.value = "";
        await renderQuestion();
        await renderAnswers();
      }catch(e){
        showWarn(ansWarn, "æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(e);
      }
    });

    await renderQuestion();
    await renderAnswers();
    await renderRelated();
  }

 window.addEventListener("DOMContentLoaded", () => {
  boot().catch(e => {
    console.error("boot failed:", e);
    alert("ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  });
});

</script>
</body>
</html>
