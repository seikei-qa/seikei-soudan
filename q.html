<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è³ªå•è©³ç´° | æ•´å½¢ç›¸è«‡å®¤</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="wrap">
    <h1>è³ªå•è©³ç´°</h1>
    <nav>
      <a href="index.html">ä¸€è¦§</a>
      <a href="ask.html">è³ªå•ã™ã‚‹</a>
      <a href="rank.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
    </nav>
  </div>
</header>

<main>
  <div id="maintBox" class="card" style="display:none">
    <div class="notice">
      <b>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ï¼š</b><span id="maintMsg"></span><br>
      ç¾åœ¨ã€ŒæŠ•ç¨¿ã€ã¯åœæ­¢ä¸­ã§ã™ï¼ˆé–²è¦§ã¯å¯èƒ½ï¼‰ã€‚
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div id="status" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <button id="loginBtn" class="btn ghost" style="width:auto">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</button>
    </div>

    <h2 id="title" style="margin:10px 0 0"></h2>

    <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
      <span class="badge" id="cat"></span>
      <span class="badge" id="reg"></span>
      <span class="badge" id="who"></span>
      <span class="badge" id="counts"></span>
    </div>

    <div id="tags" style="margin-top:10px"></div>
    <div id="body" style="margin-top:12px;white-space:pre-wrap"></div>

    <div class="inline-actions">
      <button id="copyUrl" class="btn ghost" style="width:auto">URLã‚³ãƒ”ãƒ¼</button>
      <button id="likeBtn" class="btn" style="width:auto">å…±æ„Ÿ</button>
      <button id="reportQ" class="btn danger" style="width:auto">é€šå ±</button>
    </div>

    <div id="ownerActions" style="display:none;margin-top:12px">
      <hr>
      <h3 style="margin:0 0 8px">è‡ªåˆ†ã®è³ªå•ã‚’ç·¨é›†/å‰Šé™¤</h3>
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="eTitle">
      <label>æœ¬æ–‡</label>
      <textarea id="eBody"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="saveQ" class="btn" style="width:auto">ä¿å­˜</button>
        <button id="delQ" class="btn danger" style="width:auto">å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰</button>
        <div id="qMsg" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">å›ç­”ã™ã‚‹</h3>

    <label>è¡¨ç¤ºåï¼ˆä»»æ„ï¼‰</label>
    <input id="aName" placeholder="ä¾‹ï¼šçµŒé¨“è€… / åŒ¿å">

    <label>SNSï¼ˆä»»æ„ï¼‰</label>
    <input id="aSocial" placeholder="ä¾‹ï¼šX @xxxx / ç©ºæ¬„OK">

    <label>å›ç­”æœ¬æ–‡ï¼ˆå¿…é ˆï¼‰</label>
    <textarea id="aBody" placeholder="çµŒé¨“è«‡ãƒ»æ³¨æ„ç‚¹ãªã©ã€‚æ–­å®šã‚„èª¹è¬—ä¸­å‚·ã¯é¿ã‘ã¦ãã ã•ã„ã€‚"></textarea>

    <div class="row" style="margin-top:10px">
      <button id="aBtn" class="btn" style="width:auto">å›ç­”ã‚’æŠ•ç¨¿</button>
      <div id="aStatus" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">å›ç­”ä¸€è¦§</h3>
      <select id="ansSort" style="width:auto">
        <option value="best" selected>ãƒ™ã‚¹ãƒˆå„ªå…ˆ â†’ å‚è€ƒãŒå¤šã„é †</option>
        <option value="help">å‚è€ƒã«ãªã£ãŸãŒå¤šã„é †</option>
        <option value="old">å¤ã„é †</option>
      </select>
    </div>

    <div id="answers"></div>
  </div>
</main>

<script type="module">
  import {
    ensureAnonAuth, currentUid, currentUser,
    esc, containsDanger,
    getQuestion, listAnswers, addAnswer,
    toggleLikeQuestion, isLiked,
    toggleHelpful, isHelpful,
    updateQuestion, softDeleteQuestion,
    updateAnswer, softDeleteAnswer,
    createReport, copyToClipboard,
    getSiteConfig,
    setBestAnswer, setThanks,
    listReplies, addReply, updateReply, softDeleteReply,
    optionalGoogleLogin
  } from "./app.js";

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  let qData = null;
  let answersCache = [];
  let maintenance = false;
  let isOwner = false;

  function siteUrl(){ return location.href; }

  function renderTags(tags){
    const el = document.getElementById("tags");
    el.innerHTML = (tags||[]).map(t=>`<span class="pill tag" data-tag="${esc(t)}">#${esc(t)}</span>`).join("");
  }

  function sortAnswers(list, mode){
    const cp = list.slice().filter(a => !a.data?.deleted);
    if(mode==="old") return cp;
    if(mode==="help") return cp.sort((a,b)=> (b.data.helpfulCount||0) - (a.data.helpfulCount||0));
    // best: ãƒ™ã‚¹ãƒˆã‚’å…ˆé ­ã€ãã®å¾Œhelpful desc
    return cp.sort((a,b)=>{
      const ab = a.data.best ? 1 : 0;
      const bb = b.data.best ? 1 : 0;
      if(bb !== ab) return bb - ab;
      return (b.data.helpfulCount||0) - (a.data.helpfulCount||0);
    });
  }

  async function renderReplies(qid, aid){
    const reps = (await listReplies(qid, aid)).filter(r=>!r.data.deleted);
    if(!reps.length) return `<div class="muted" style="margin-top:8px">è¿”ä¿¡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;

    return reps.map(r=>{
      const d=r.data;
      const mine = (d.ownerUid && currentUid && d.ownerUid === currentUid);
      return `
        <div class="card" style="margin:10px 0 0; padding:12px">
          <div class="row" style="justify-content:space-between">
            <div><b>${esc(d.displayName||"åŒ¿å")}</b> ${d.social?`<small>ï¼ˆ${esc(d.social)}ï¼‰</small>`:""}</div>
            ${mine ? `<button class="btn danger softDelReply" data-aid="${aid}" data-rid="${r.id}" style="width:auto">å‰Šé™¤</button>` : ``}
          </div>
          <div style="white-space:pre-wrap;margin-top:6px">${esc(d.body||"")}</div>
          ${mine ? `
            <div style="margin-top:8px">
              <textarea class="editReplyText" data-aid="${aid}" data-rid="${r.id}" style="min-height:80px">${esc(d.body||"")}</textarea>
              <div class="row" style="margin-top:6px">
                <button class="btn ghost saveReply" data-aid="${aid}" data-rid="${r.id}" style="width:auto">ç·¨é›†ä¿å­˜</button>
              </div>
            </div>
          ` : ``}
        </div>
      `;
    }).join("");
  }

  async function renderAnswers(){
    const mode = document.getElementById("ansSort").value;
    const list = sortAnswers(answersCache, mode);

    const el = document.getElementById("answers");
    if(!list.length){
      el.innerHTML = `<div class="muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    el.innerHTML = await Promise.all(list.map(async (a)=>{
      const d=a.data;
      const mine = (d.ownerUid && currentUid && d.ownerUid === currentUid);
      const helpful = await isHelpful(id, a.id).catch(()=>false);
      const bestBadge = d.best ? `<span class="badge" style="border-color:#d4af37">ğŸ† ãƒ™ã‚¹ãƒˆå›ç­”</span>` : ``;

      const thanks = (d.thanksText || "").trim();
      const thanksBox = thanks ? `
        <div class="notice" style="margin-top:10px">
          <b>è³ªå•è€…ã‹ã‚‰ã®ãŠç¤¼ï¼š</b><br>${esc(thanks)}
        </div>
      ` : ``;

      const repliesHtml = await renderReplies(id, a.id);

      return `
        <div class="qitem" data-aid="${a.id}">
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <div><b>${esc(d.displayName || "åŒ¿å")}</b> ${d.social?`<small>ï¼ˆ${esc(d.social)}ï¼‰</small>`:""}</div>
              <div style="margin-top:6px">${bestBadge}</div>
            </div>
            <small>å‚è€ƒï¼š${d.helpfulCount||0}</small>
          </div>

          <div class="muted" style="margin-top:6px;white-space:pre-wrap">${esc(d.body || "")}</div>

          ${thanksBox}

          <div class="inline-actions">
            <button class="btn helpfulBtn" data-aid="${a.id}" style="width:auto" ${maintenance ? "disabled" : ""}>
              ${helpful ? "å‚è€ƒã«ãªã£ãŸï¼ˆè§£é™¤ï¼‰" : "å‚è€ƒã«ãªã£ãŸ"}
            </button>
            <button class="btn ghost reportA" data-aid="${a.id}" style="width:auto">é€šå ±</button>

            ${isOwner ? `
              <button class="btn" data-aid="${a.id}" class="bestBtn" style="width:auto" ${maintenance ? "disabled" : ""} onclick="return false;">ãƒ™ã‚¹ãƒˆã«ã™ã‚‹</button>
              <button class="btn ghost toggleThanks" data-aid="${a.id}" style="width:auto">ãŠç¤¼ã‚’æ›¸ã</button>
            ` : ``}

            ${mine ? `
              <button class="btn ghost editA" data-aid="${a.id}" style="width:auto">ç·¨é›†</button>
              <button class="btn danger delA" data-aid="${a.id}" style="width:auto">å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆï¼‰</button>
            ` : ""}
          </div>

          <div class="editBox" data-aid="${a.id}" style="display:none;margin-top:10px">
            <label>å›ç­”ã‚’ç·¨é›†</label>
            <textarea class="editText">${esc(d.body||"")}</textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn saveA" data-aid="${a.id}" style="width:auto" ${maintenance ? "disabled" : ""}>ä¿å­˜</button>
              <div class="muted msg"></div>
            </div>
          </div>

          <div class="thanksBox" data-aid="${a.id}" style="display:none;margin-top:10px">
            <label>è³ªå•è€…ã‹ã‚‰ã®ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea class="thanksText" style="min-height:90px" placeholder="ä¾‹ï¼šã™ã”ãå‚è€ƒã«ãªã‚Šã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚">${esc(d.thanksText||"")}</textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn saveThanks" data-aid="${a.id}" style="width:auto" ${maintenance ? "disabled" : ""}>ãŠç¤¼ã‚’ä¿å­˜</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px; padding:12px">
            <div class="row" style="justify-content:space-between">
              <b>è¿”ä¿¡ï¼ˆä¼šè©±ï¼‰</b>
              <small class="muted">â€»å…¨å“¡è¿”ä¿¡OK</small>
            </div>

            <label style="margin-top:8px">è¿”ä¿¡ã‚’æ›¸ã</label>
            <input class="rName" placeholder="è¡¨ç¤ºåï¼ˆä»»æ„ï¼‰">
            <input class="rSocial" placeholder="SNSï¼ˆä»»æ„ï¼‰">
            <textarea class="rBody" placeholder="è¿½åŠ è³ªå•ãƒ»è£œè¶³ãƒ»æ„Ÿæƒ³ãªã©"></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn addReply" data-aid="${a.id}" style="width:auto" ${maintenance ? "disabled" : ""}>è¿”ä¿¡ã™ã‚‹</button>
            </div>

            <div class="replies" style="margin-top:10px">
              ${repliesHtml}
            </div>
          </div>

        </div>
      `;
    })).then(x=>x.join(""));
  }

  async function load(){
    const status = document.getElementById("status");
    if(!id){ status.textContent = "ä¸æ­£ãªURLã§ã™"; return; }

    status.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    await ensureAnonAuth();

    const cfg = await getSiteConfig().catch(()=>({maintenance:false,message:""}));
    maintenance = !!cfg.maintenance;
    if(maintenance){
      document.getElementById("maintBox").style.display = "block";
      document.getElementById("maintMsg").textContent = cfg.message || "ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
      document.getElementById("aBtn").disabled = true;
      document.getElementById("likeBtn").disabled = true;
    }

    const q = await getQuestion(id);
    if(!q){ status.textContent = "è³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return; }
    qData = q.data;

    if(qData.deleted){
      status.textContent = "ã“ã®è³ªå•ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚";
      document.getElementById("title").textContent = "(å‰Šé™¤æ¸ˆã¿)";
      document.getElementById("body").textContent = "";
      return;
    }

    isOwner = (qData.ownerUid && currentUid && qData.ownerUid === currentUid);

    document.getElementById("title").textContent = qData.title || "";
    document.getElementById("cat").textContent = "ã‚«ãƒ†ã‚´ãƒªï¼š" + (qData.category || "æœªè¨­å®š");
    document.getElementById("reg").textContent = "åœ°åŸŸï¼š" + (qData.region || "æœªè¨­å®š");
    document.getElementById("who").textContent = "æŠ•ç¨¿è€…ï¼š" + (qData.displayName || "åŒ¿å") + (qData.social?`ï¼ˆ${qData.social}ï¼‰`:"");
    document.getElementById("counts").textContent = `å…±æ„Ÿï¼š${qData.likeCount||0}ï½œå›ç­”ï¼š${qData.answerCount||0}`;
    document.getElementById("body").textContent = qData.body || "";
    renderTags(Array.isArray(qData.tags) ? qData.tags : []);

    const liked = await isLiked(id).catch(()=>false);
    document.getElementById("likeBtn").textContent = liked ? "å…±æ„Ÿï¼ˆè§£é™¤ï¼‰" : "å…±æ„Ÿ";

    if(isOwner){
      document.getElementById("ownerActions").style.display = "block";
      document.getElementById("eTitle").value = qData.title || "";
      document.getElementById("eBody").value = qData.body || "";
      if(maintenance){
        document.getElementById("saveQ").disabled = true;
        document.getElementById("delQ").disabled = true;
      }
    }

    answersCache = await listAnswers(id);
    status.textContent = "";
    await renderAnswers();
  }

  // ä»»æ„ãƒ­ã‚°ã‚¤ãƒ³
  document.getElementById("loginBtn")?.addEventListener("click", async ()=>{
    const r = await optionalGoogleLogin();
    if(r.ok) alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆä»»æ„ï¼‰");
    else alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Firebase Authã§Googleã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚\n" + (r.error||""));
    await load();
  });

  // URLã‚³ãƒ”ãƒ¼
  document.getElementById("copyUrl").addEventListener("click", async ()=>{
    await copyToClipboard(siteUrl());
    alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });

  // å…±æ„Ÿ
  document.getElementById("likeBtn").addEventListener("click", async ()=>{
    if(maintenance) return;
    await toggleLikeQuestion(id);
    await load();
  });

  // è³ªå•ç·¨é›†
  document.getElementById("saveQ")?.addEventListener("click", async ()=>{
    if(maintenance) return;
    const msg = document.getElementById("qMsg");
    const title = document.getElementById("eTitle").value.trim();
    const body = document.getElementById("eBody").value.trim();
    if(!title || !body){ alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã¯å¿…é ˆ"); return; }
    if(containsDanger(title+" "+body)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }
    msg.textContent = "ä¿å­˜ä¸­â€¦";
    await updateQuestion(id, { title, body });
    msg.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
    await load();
  });

  // è³ªå•å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆï¼‰
  document.getElementById("delQ")?.addEventListener("click", async ()=>{
    if(maintenance) return;
    if(!confirm("ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    await softDeleteQuestion(id);
    location.href = "index.html";
  });

  // è³ªå•é€šå ±
  document.getElementById("reportQ").addEventListener("click", async ()=>{
    const reason = prompt("é€šå ±ç†ç”±ï¼ˆä¾‹ï¼šå€‹äººæƒ…å ±/èª¹è¬—ä¸­å‚·/åº—èˆ—ã‚„åŒ»å¸«ç‰¹å®š/ã‚¹ãƒ‘ãƒ  ç­‰ï¼‰");
    if(!reason) return;
    await createReport({ targetType:"question", qid:id, reason, pageUrl: siteUrl() });
    alert("é€šå ±ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
  });

  // å›ç­”æŠ•ç¨¿
  document.getElementById("aBtn").addEventListener("click", async ()=>{
    if(maintenance) return;
    const st = document.getElementById("aStatus");
    const displayName = document.getElementById("aName").value.trim();
    const social = document.getElementById("aSocial").value.trim();
    const body = document.getElementById("aBody").value.trim();
    if(!body){ alert("å›ç­”æœ¬æ–‡ã¯å¿…é ˆ"); return; }
    if(containsDanger(body)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }

    st.textContent = "é€ä¿¡ä¸­â€¦";
    await addAnswer(id, { displayName, social, body });
    document.getElementById("aBody").value = "";
    st.textContent = "";
    await load();
  });

  // å›ç­”ä¸¦ã³æ›¿ãˆ
  document.getElementById("ansSort").addEventListener("change", renderAnswers);

  // å„ç¨®ã‚¯ãƒªãƒƒã‚¯
  document.addEventListener("click", async (e)=>{
    const t = e.target;

    if(t.classList.contains("tag")){
      const tag = t.dataset.tag || "";
      location.href = `index.html?search=${encodeURIComponent(tag)}`;
    }

    if(t.classList.contains("helpfulBtn")){
      if(maintenance) return;
      const aid = t.dataset.aid;
      await toggleHelpful(id, aid);
      await load();
    }

    if(t.classList.contains("reportA")){
      const aid = t.dataset.aid;
      const reason = prompt("é€šå ±ç†ç”±ï¼ˆä¾‹ï¼šå€‹äººæƒ…å ±/èª¹è¬—ä¸­å‚·/åº—èˆ—ã‚„åŒ»å¸«ç‰¹å®š/ã‚¹ãƒ‘ãƒ  ç­‰ï¼‰");
      if(!reason) return;
      await createReport({ targetType:"answer", qid:id, aid, reason, pageUrl: siteUrl() });
      alert("é€šå ±ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
    }

    // ãƒ™ã‚¹ãƒˆã«ã™ã‚‹ï¼ˆè³ªå•è€…ï¼‰
    if(isOwner && t.textContent === "ãƒ™ã‚¹ãƒˆã«ã™ã‚‹"){
      if(maintenance) return;
      const aid = t.getAttribute("data-aid");
      await setBestAnswer(id, aid);
      await load();
    }

    // ãŠç¤¼æ¬„ã®è¡¨ç¤º
    if(t.classList.contains("toggleThanks")){
      const aid = t.dataset.aid;
      const box = document.querySelector(`.thanksBox[data-aid="${aid}"]`);
      if(box) box.style.display = (box.style.display==="none" ? "block" : "none");
    }

    // ãŠç¤¼ä¿å­˜
    if(t.classList.contains("saveThanks")){
      if(maintenance) return;
      const aid = t.dataset.aid;
      const wrap = document.querySelector(`.qitem[data-aid="${aid}"]`);
      const text = wrap?.querySelector(".thanksText")?.value?.trim() || "";
      if(containsDanger(text)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }
      await setThanks(id, aid, text);
      await load();
    }

    // ç·¨é›†è¡¨ç¤º
    if(t.classList.contains("editA")){
      const aid = t.dataset.aid;
      const box = document.querySelector(`.editBox[data-aid="${aid}"]`);
      if(box) box.style.display = (box.style.display==="none" ? "block" : "none");
    }

    // å›ç­”å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆï¼‰
    if(t.classList.contains("delA")){
      if(maintenance) return;
      const aid = t.dataset.aid;
      if(!confirm("ã“ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      await softDeleteAnswer(id, aid);
      await load();
    }

    // å›ç­”ä¿å­˜
    if(t.classList.contains("saveA")){
      if(maintenance) return;
      const aid = t.dataset.aid;
      const wrap = document.querySelector(`.qitem[data-aid="${aid}"]`);
      const ta = wrap?.querySelector(".editText");
      const msg = wrap?.querySelector(".msg");
      const body = ta?.value?.trim() || "";
      if(!body){ alert("æœ¬æ–‡ã¯å¿…é ˆ"); return; }
      if(containsDanger(body)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }
      if(msg) msg.textContent = "ä¿å­˜ä¸­â€¦";
      await updateAnswer(id, aid, { body });
      if(msg) msg.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
      await load();
    }

    // è¿”ä¿¡æŠ•ç¨¿
    if(t.classList.contains("addReply")){
      if(maintenance) return;
      const aid = t.dataset.aid;
      const wrap = document.querySelector(`.qitem[data-aid="${aid}"]`);
      const name = wrap?.querySelector(".rName")?.value?.trim() || "";
      const social = wrap?.querySelector(".rSocial")?.value?.trim() || "";
      const body = wrap?.querySelector(".rBody")?.value?.trim() || "";
      if(!body){ alert("è¿”ä¿¡æœ¬æ–‡ã¯å¿…é ˆ"); return; }
      if(containsDanger(body)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }
      await addReply(id, aid, { displayName:name, social, body });
      await load();
    }

    // è¿”ä¿¡ç·¨é›†ä¿å­˜
    if(t.classList.contains("saveReply")){
      const aid = t.dataset.aid;
      const rid = t.dataset.rid;
      const ta = document.querySelector(`textarea.editReplyText[data-aid="${aid}"][data-rid="${rid}"]`);
      const body = ta?.value?.trim() || "";
      if(!body){ alert("è¿”ä¿¡æœ¬æ–‡ã¯å¿…é ˆ"); return; }
      if(containsDanger(body)){ alert("æ”»æ’ƒçš„ãƒ»æ–­å®šçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); return; }
      await updateReply(id, aid, rid, { body });
      await load();
    }

    // è¿”ä¿¡å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆï¼‰
    if(t.classList.contains("softDelReply")){
      const aid = t.dataset.aid;
      const rid = t.dataset.rid;
      if(!confirm("è¿”ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆã‚½ãƒ•ãƒˆï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      await softDeleteReply(id, aid, rid);
      await load();
    }
  });

  load();
</script>
</body>
</html>
