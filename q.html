<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>質問詳細 | 整形相談室</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="wrap">
    <h1>質問詳細</h1>
    <nav>
      <a href="index.html">一覧</a>
      <a href="ask.html">質問する</a>
    </nav>
  </div>
</header>

<main>
  <div class="card">
    <div id="status" class="muted">読み込み中…</div>

    <h2 id="title" style="margin:10px 0 0"></h2>

    <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
      <span class="badge" id="cat"></span>
      <span class="badge" id="reg"></span>
      <span class="badge" id="who"></span>
      <span class="badge" id="counts"></span>
    </div>

    <div id="tags" style="margin-top:10px"></div>
    <div id="body" style="margin-top:12px;white-space:pre-wrap"></div>

    <hr>

    <div class="row">
      <button id="likeBtn" class="btn" style="width:auto">共感</button>
      <div class="muted">※もう一回押すと解除</div>
    </div>

    <div id="ownerActions" style="display:none;margin-top:12px">
      <hr>
      <h3 style="margin:0 0 8px">自分の質問を編集/削除</h3>
      <label>タイトル</label>
      <input id="eTitle">
      <label>本文</label>
      <textarea id="eBody"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="saveQ" class="btn" style="width:auto">保存</button>
        <button id="delQ" class="btn" style="width:auto;background:#b00020">削除</button>
        <div id="qMsg" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">回答する</h3>

    <label>表示名（任意）</label>
    <input id="aName" placeholder="例：経験者 / 匿名">

    <label>SNS（任意）</label>
    <input id="aSocial" placeholder="例：X @xxxx / 空欄OK">

    <label>回答本文（必須）</label>
    <textarea id="aBody" placeholder="経験談・注意点など。断定や誹謗中傷は避けてください。"></textarea>

    <div class="row" style="margin-top:10px">
      <button id="aBtn" class="btn" style="width:auto">回答を投稿</button>
      <div id="aStatus" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">回答一覧</h3>
      <select id="ansSort" style="width:auto">
        <option value="new">古い順</option>
        <option value="help">参考になったが多い順</option>
      </select>
    </div>
    <div id="answers"></div>
  </div>
</main>

<script type="module">
  import {
    ensureAnonAuth, currentUid, esc, containsDanger,
    getQuestion, listAnswers, addAnswer,
    toggleLikeQuestion, isLiked,
    toggleHelpful, isHelpful,
    updateQuestion, deleteQuestion,
    updateAnswer, deleteAnswer
  } from "./app.js";

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  let qData = null; // current question
  let answersCache = [];

  function sortAnswers(list, mode){
    const cp = list.slice();
    if(mode==="help") return cp.sort((a,b)=> (b.data.helpfulCount||0) - (a.data.helpfulCount||0));
    return cp; // createdAt asc のまま
  }

  async function renderAnswers(){
    const mode = document.getElementById("ansSort").value;
    const list = sortAnswers(answersCache, mode);

    const el = document.getElementById("answers");
    if(!list.length){
      el.innerHTML = `<div class="muted">まだ回答がありません。</div>`;
      return;
    }

    // 自分の回答だけ編集/削除ボタンを出す
    el.innerHTML = await Promise.all(list.map(async (a)=>{
      const d=a.data;
      const mine = (d.ownerUid && currentUid && d.ownerUid === currentUid);

      const helpful = await isHelpful(id, a.id).catch(()=>false);

      return `
        <div class="qitem" data-aid="${a.id}">
          <div class="row" style="justify-content:space-between">
            <div><b>${esc(d.displayName || "匿名")}</b> ${d.social?`<small>（${esc(d.social)}）</small>`:""}</div>
            <small>参考：${d.helpfulCount||0}</small>
          </div>

          <div class="muted" style="margin-top:6px;white-space:pre-wrap">${esc(d.body || "")}</div>

          <div class="row" style="margin-top:10px">
            <button class="btn helpfulBtn" data-aid="${a.id}" style="width:auto">${helpful ? "参考になった（解除）" : "参考になった"}</button>
            ${mine ? `
              <button class="btn editA" data-aid="${a.id}" style="width:auto;background:#444">編集</button>
              <button class="btn delA" data-aid="${a.id}" style="width:auto;background:#b00020">削除</button>
            ` : ""}
          </div>

          <div class="editBox" data-aid="${a.id}" style="display:none;margin-top:10px">
            <label>回答を編集</label>
            <textarea class="editText">${esc(d.body||"")}</textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn saveA" data-aid="${a.id}" style="width:auto">保存</button>
              <div class="muted msg"></div>
            </div>
          </div>
        </div>
      `;
    })).then(x=>x.join(""));
  }

  async function load(){
    const status = document.getElementById("status");
    if(!id){ status.textContent = "不正なURLです"; return; }

    status.textContent = "読み込み中…";
    await ensureAnonAuth();

    const q = await getQuestion(id);
    if(!q){ status.textContent = "質問が見つかりません"; return; }
    qData = q.data;

    document.getElementById("title").textContent = qData.title || "";
    document.getElementById("cat").textContent = "カテゴリ：" + (qData.category || "未設定");
    document.getElementById("reg").textContent = "地域：" + (qData.region || "未設定");
    document.getElementById("who").textContent = "投稿者：" + (qData.displayName || "匿名") + (qData.social?`（${qData.social}）`:"");
    document.getElementById("counts").textContent = `共感：${qData.likeCount||0}｜回答：${qData.answerCount||0}`;
    document.getElementById("body").textContent = qData.body || "";

    const tags = Array.isArray(qData.tags) ? qData.tags : [];
    document.getElementById("tags").innerHTML = tags.map(t=>`<span class="pill">#${esc(t)}</span>`).join("");

    // Like状態
    const liked = await isLiked(id).catch(()=>false);
    document.getElementById("likeBtn").textContent = liked ? "共感（解除）" : "共感";

    // ownerなら編集欄を出す
    if(qData.ownerUid && currentUid && qData.ownerUid === currentUid){
      document.getElementById("ownerActions").style.display = "block";
      document.getElementById("eTitle").value = qData.title || "";
      document.getElementById("eBody").value = qData.body || "";
    }

    // answers
    answersCache = await listAnswers(id);
    status.textContent = "";
    await renderAnswers();
  }

  // 共感
  document.getElementById("likeBtn").addEventListener("click", async ()=>{
    await toggleLikeQuestion(id);
    await load();
  });

  // 質問編集
  document.getElementById("saveQ")?.addEventListener("click", async ()=>{
    const msg = document.getElementById("qMsg");
    const title = document.getElementById("eTitle").value.trim();
    const body = document.getElementById("eBody").value.trim();
    if(!title || !body){ alert("タイトルと本文は必須"); return; }
    if(containsDanger(title+" "+body)){ alert("攻撃的・断定的な表現が含まれる可能性があります"); return; }
    msg.textContent = "保存中…";
    await updateQuestion(id, { title, body });
    msg.textContent = "保存しました";
    await load();
  });

  // 質問削除
  document.getElementById("delQ")?.addEventListener("click", async ()=>{
    if(!confirm("この質問を削除します。よろしいですか？")) return;
    await deleteQuestion(id);
    location.href = "index.html";
  });

  // 回答投稿
  document.getElementById("aBtn").addEventListener("click", async ()=>{
    const st = document.getElementById("aStatus");
    const displayName = document.getElementById("aName").value.trim();
    const social = document.getElementById("aSocial").value.trim();
    const body = document.getElementById("aBody").value.trim();
    if(!body){ alert("回答本文は必須"); return; }
    if(containsDanger(body)){ alert("攻撃的・断定的な表現が含まれる可能性があります"); return; }

    st.textContent = "送信中…";
    await addAnswer(id, { displayName, social, body });
    document.getElementById("aBody").value = "";
    st.textContent = "";
    await load();
  });

  // 回答並び替え
  document.getElementById("ansSort").addEventListener("change", renderAnswers);

  // 回答のボタン群（イベント委任）
  document.addEventListener("click", async (e)=>{
    const t = e.target;

    // 参考になった
    if(t.classList.contains("helpfulBtn")){
      const aid = t.dataset.aid;
      await toggleHelpful(id, aid);
      await load();
    }

    // 編集表示
    if(t.classList.contains("editA")){
      const aid = t.dataset.aid;
      const box = document.querySelector(`.editBox[data-aid="${aid}"]`);
      if(box) box.style.display = (box.style.display==="none" ? "block" : "none");
    }

    // 回答削除
    if(t.classList.contains("delA")){
      const aid = t.dataset.aid;
      if(!confirm("この回答を削除します。よろしいですか？")) return;
      await deleteAnswer(id, aid);
      await load();
    }

    // 回答保存
    if(t.classList.contains("saveA")){
      const aid = t.dataset.aid;
      const wrap = document.querySelector(`.qitem[data-aid="${aid}"]`);
      const ta = wrap?.querySelector(".editText");
      const msg = wrap?.querySelector(".msg");
      const body = ta?.value?.trim() || "";
      if(!body){ alert("本文は必須"); return; }
      if(containsDanger(body)){ alert("攻撃的・断定的な表現が含まれる可能性があります"); return; }
      if(msg) msg.textContent = "保存中…";
      await updateAnswer(id, aid, { body });
      if(msg) msg.textContent = "保存しました";
      await load();
    }
  });

  load();
</script>
</body>
</html>
