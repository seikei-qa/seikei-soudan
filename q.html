<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è³ªå•è©³ç´°</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    /* ã‚‚ã—style.cssã«ç„¡ã„å ´åˆã®æœ€ä½é™ */
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:12px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .muted{color:#666}
    .danger{color:#b00020}
    .btn{border:1px solid #cfd5e5;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.ghost{background:#fff}
    textarea,input{width:100%;box-sizing:border-box;border:1px solid #cfd5e5;border-radius:10px;padding:10px}
    textarea{min-height:110px}
    .pill{display:inline-block;font-size:12px;border:1px solid #e6e8ef;border-radius:999px;padding:2px 8px}
    .ans{margin-top:12px}
    .ansHead{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ansBody{margin-top:8px;white-space:pre-wrap}
    .reply{margin-top:10px;padding-left:12px;border-left:2px solid #eee}
    .small{font-size:12px}
    .sep{height:1px;background:#e6e8ef;margin:12px 0}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="row" style="margin-bottom:12px">
      <a class="btn ghost" href="index.html">â† ä¸€è¦§ã¸</a>
      <a class="btn ghost" href="rank.html">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
      <span class="right muted small" id="uidInfo"></span>
    </div>

    <!-- ãƒ¡ãƒ³ãƒ†è¡¨ç¤º -->
    <div id="maintBox" class="card" style="display:none;border-color:#ffd1d1;background:#fff5f5;margin-bottom:12px">
      <b class="danger">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</b>
      <div id="maintMsg" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- è³ªå• -->
    <div class="card" id="qBox">
      <div class="row">
        <div>
          <div class="muted small">è³ªå•</div>
          <h2 id="qTitle" style="margin:6px 0 0 0"></h2>
        </div>
        <div class="right row">
          <button id="copyBtn" class="btn ghost" style="width:auto">URLã‚³ãƒ”ãƒ¼</button>

          <!-- â˜…ä¿å­˜ï¼ˆã‚¦ã‚©ãƒƒãƒï¼‰ -->
          <button id="watchBtn" class="btn ghost" style="width:auto">â˜† ä¿å­˜</button>

          <!-- å…±æ„Ÿ -->
          <button id="likeBtn" class="btn ghost" style="width:auto">å…±æ„Ÿ</button>

          <!-- ä»»æ„ãƒ­ã‚°ã‚¤ãƒ³ -->
          <button id="loginBtn" class="btn ghost" style="width:auto">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</button>
        </div>
      </div>

      <div id="qMeta" class="muted small" style="margin-top:6px"></div>
      <div id="watchMsg" class="muted small" style="margin-top:6px"></div>

      <div id="qBody" style="margin-top:10px;white-space:pre-wrap"></div>

      <div class="sep"></div>

      <!-- è³ªå•è€…ã®ã¿ï¼šç·¨é›†/å‰Šé™¤ -->
      <div id="qOwnerTools" class="row" style="display:none">
        <button id="qEditBtn" class="btn ghost" style="width:auto">è³ªå•ã‚’ç·¨é›†</button>
        <button id="qDeleteBtn" class="btn ghost danger" style="width:auto">è³ªå•ã‚’å‰Šé™¤</button>
      </div>

      <!-- è³ªå•ç·¨é›†ï¼ˆè³ªå•è€…ã®ã¿ï¼‰ -->
      <div id="qEditBox" style="display:none;margin-top:12px">
        <div class="muted small">ã‚¿ã‚¤ãƒˆãƒ«</div>
        <input id="qEditTitle" type="text" />
        <div class="muted small" style="margin-top:8px">æœ¬æ–‡</div>
        <textarea id="qEditBody"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="qEditSaveBtn" class="btn primary" style="width:auto">ä¿å­˜</button>
          <button id="qEditCancelBtn" class="btn ghost" style="width:auto">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="qEditWarn" class="danger small" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- å›ç­”æŠ•ç¨¿ -->
    <div class="card">
      <div class="row">
        <b>å›ç­”ã™ã‚‹</b>
        <span class="muted small">ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</span>
      </div>
      <textarea id="answerText" placeholder="ã§ãã‚‹ã ã‘å…·ä½“çš„ã«ã€‚çµŒé¨“è«‡ã‚„æ ¹æ‹ ãŒã‚ã‚‹ã¨å¼·ã„ã§ã™ã€‚"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="answerBtn" class="btn primary" style="width:auto">å›ç­”ã‚’æŠ•ç¨¿</button>
        <span id="dangerWarn" class="danger small"></span>
      </div>
    </div>

    <div class="sep"></div>

    <!-- å›ç­”ä¸€è¦§ -->
    <div class="card">
      <div class="row">
        <b>å›ç­”ä¸€è¦§</b>
        <span id="ansCount" class="muted small"></span>
      </div>
      <div id="answersBox" style="margin-top:10px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>

  </div>

  <script type="module">
    import {
      ensureAnonAuth, optionalGoogleLogin, getSiteConfig,
      esc, containsDanger, copyToClipboard,
      getQuestion, updateQuestion, softDeleteQuestion,
      listAnswers, addAnswer, updateAnswer, softDeleteAnswer,
      setBestAnswer, setThanks,
      listReplies, addReply, updateReply, softDeleteReply,
      toggleHelpful, isHelpful,
      toggleLikeQuestion, isLiked,
      isWatching, toggleWatchQuestion,
      createReport,
      currentUid
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);

    function getQid(){
      const u = new URL(location.href);
      return u.searchParams.get("id");
    }

    function fmtTime(ts){
      const sec = ts?.seconds;
      if(!sec) return "";
      const d = new Date(sec*1000);
      return d.toLocaleString();
    }

    async function boot(){
      const qid = getQid();
      if(!qid){
        $("qBox").innerHTML = "<b>URLãŒä¸æ­£ã§ã™</b>";
        return;
      }

      // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ç¢ºä¿
      await ensureAnonAuth();
      $("uidInfo").textContent = `UID: ${currentUid}`;

      // ãƒ¡ãƒ³ãƒ†è¡¨ç¤ºï¼ˆã‚ã‚‹å ´åˆï¼‰
      try{
        const conf = await getSiteConfig();
        if(conf?.maintenance){
          $("maintBox").style.display = "block";
          $("maintMsg").textContent = conf.message || "";
        }
      }catch{}

      // ä»»æ„ãƒ­ã‚°ã‚¤ãƒ³
      $("loginBtn").addEventListener("click", async ()=>{
        const res = await optionalGoogleLogin();
        if(res.ok){
          alert("ãƒ­ã‚°ã‚¤ãƒ³OKï¼ˆä»»æ„ï¼‰");
        }else{
          alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (res.error || ""));
        }
      });

      // URLã‚³ãƒ”ãƒ¼
      $("copyBtn").addEventListener("click", async ()=>{
        const ok = await copyToClipboard(location.href);
        if(ok) alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      });

      // è³ªå•å–å¾—
      await renderQuestion(qid);

      // ä¿å­˜ãƒœã‚¿ãƒ³
      await setupWatch(qid);

      // å…±æ„Ÿãƒœã‚¿ãƒ³
      await setupLike(qid);

      // å›ç­”æŠ•ç¨¿
      $("answerBtn").addEventListener("click", async ()=>{
        const text = ($("answerText").value || "").trim();
        if(!text) return alert("å›ç­”æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ã­");

        if(containsDanger(text)){
          $("dangerWarn").textContent = "âš  å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ–­å®šãƒ»æ”»æ’ƒè¡¨ç¾ã¯é¿ã‘ã¦ã€ä½“é¨“ã¨ã—ã¦æ›¸ã„ã¦ã­ã€‚";
          return;
        }else{
          $("dangerWarn").textContent = "";
        }

        $("answerBtn").disabled = true;
        try{
          await addAnswer(qid, { body: text });
          $("answerText").value = "";
          await renderAnswers(qid);
          alert("å›ç­”ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ");
        }catch(e){
          console.error(e);
          alert("æŠ•ç¨¿ã«å¤±æ•—: " + (e?.message || e));
        }finally{
          $("answerBtn").disabled = false;
        }
      });

      // å›ç­”ä¸€è¦§
      await renderAnswers(qid);
    }

    async function renderQuestion(qid){
      const q = await getQuestion(qid);
      if(!q || q.data?.deleted){
        $("qBox").innerHTML = "<b>ã“ã®è³ªå•ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå‰Šé™¤æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰</b>";
        return;
      }

      const d = q.data;
      $("qTitle").innerHTML = esc(d.title || "(ç„¡é¡Œ)");
      $("qBody").innerHTML  = esc(d.body || "");
      $("qMeta").textContent = `å…±æ„Ÿ:${d.likeCount||0} / å›ç­”:${d.answerCount||0} / ä½œæˆ:${fmtTime(d.createdAt)} ${d.bestAnswerId ? " / ğŸ†è§£æ±ºæ¸ˆ" : " / ğŸŸ¡æœªè§£æ±º"}`;

      // è³ªå•è€…ãƒ„ãƒ¼ãƒ«
      const isOwner = d.ownerUid && d.ownerUid === currentUid;
      $("qOwnerTools").style.display = isOwner ? "flex" : "none";

      if(isOwner){
        $("qEditBtn").onclick = ()=>{
          $("qEditBox").style.display = "block";
          $("qEditTitle").value = d.title || "";
          $("qEditBody").value = d.body || "";
          $("qEditWarn").textContent = "";
        };

        $("qEditCancelBtn").onclick = ()=>{
          $("qEditBox").style.display = "none";
        };

        $("qEditSaveBtn").onclick = async ()=>{
          const nt = ($("qEditTitle").value||"").trim();
          const nb = ($("qEditBody").value||"").trim();
          if(!nt) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");

          // å±é™ºãƒ¯ãƒ¼ãƒ‰è»½ãè­¦å‘Š
          if(containsDanger(nt + " " + nb)){
            $("qEditWarn").textContent = "âš  å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ–­å®šãƒ»æ”»æ’ƒè¡¨ç¾ã¯é¿ã‘ã¦ã­ã€‚";
            return;
          }

          $("qEditSaveBtn").disabled = true;
          try{
            await updateQuestion(qid, { title: nt, body: nb });
            $("qEditBox").style.display = "none";
            await renderQuestion(qid);
            alert("æ›´æ–°ã—ã¾ã—ãŸ");
          }catch(e){
            console.error(e);
            alert("æ›´æ–°å¤±æ•—: " + (e?.message || e));
          }finally{
            $("qEditSaveBtn").disabled = false;
          }
        };

        $("qDeleteBtn").onclick = async ()=>{
          if(!confirm("è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰")) return;
          try{
            await softDeleteQuestion(qid);
            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            location.href = "index.html";
          }catch(e){
            console.error(e);
            alert("å‰Šé™¤å¤±æ•—: " + (e?.message || e));
          }
        };
      }
    }

    async function setupWatch(qid){
      async function refresh(){
        const w = await isWatching(qid);
        $("watchBtn").textContent = w ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
        $("watchMsg").textContent = w ? "ã“ã®è³ªå•ã«æ–°ã—ã„å›ç­”ãŒä»˜ãã¨é€šçŸ¥ã—ã¾ã™" : "";
      }

      $("watchBtn").addEventListener("click", async ()=>{
        try{
          const res = await toggleWatchQuestion(qid);
          $("watchBtn").textContent = res.watching ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
          $("watchMsg").textContent = res.watching ? "ã“ã®è³ªå•ã«æ–°ã—ã„å›ç­”ãŒä»˜ãã¨é€šçŸ¥ã—ã¾ã™" : "";
        }catch(e){
          console.error(e);
          alert("ä¿å­˜ã«å¤±æ•—: " + (e?.message || e));
        }
      });

      await refresh();
    }

    async function setupLike(qid){
      async function refresh(){
        const liked = await isLiked(qid);
        $("likeBtn").textContent = liked ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";
      }

      $("likeBtn").addEventListener("click", async ()=>{
        try{
          await toggleLikeQuestion(qid);
          await refresh();
          await renderQuestion(qid);
        }catch(e){
          console.error(e);
          alert("å…±æ„Ÿã«å¤±æ•—: " + (e?.message || e));
        }
      });

      await refresh();
    }

    async function renderAnswers(qid){
      const q = await getQuestion(qid);
      const qData = q?.data || {};
      const isQOwner = qData.ownerUid && qData.ownerUid === currentUid;

      const list = await listAnswers(qid);
      const live = list.filter(a => !a.data?.deleted);

      $("ansCount").textContent = `ï¼ˆ${live.length}ä»¶ï¼‰`;

      const box = $("answersBox");
      box.innerHTML = "";
      if(!live.length){
        box.innerHTML = `<div class="muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      for(const a of live){
        const d = a.data || {};
        const isAOwner = d.ownerUid && d.ownerUid === currentUid;

        const wrap = document.createElement("div");
        wrap.className = "ans";
        wrap.innerHTML = `
          <div class="ansHead">
            <b>${d.best ? "ğŸ† ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼" : "å›ç­”"}</b>
            <span class="muted small">${fmtTime(d.createdAt)}</span>
            <span class="pill">å‚è€ƒ:${d.helpfulCount||0}</span>
            ${d.best ? `<span class="pill">é¸ã°ã‚Œã¾ã—ãŸ</span>` : ``}
            <span class="right row" style="gap:6px">
              <button class="btn ghost" data-act="helpful">å‚è€ƒã«ãªã£ãŸ</button>
              <button class="btn ghost" data-act="report">é€šå ±</button>
              ${isAOwner ? `<button class="btn ghost" data-act="edit">ç·¨é›†</button>` : ``}
              ${isAOwner ? `<button class="btn ghost danger" data-act="del">å‰Šé™¤</button>` : ``}
              ${isQOwner ? `<button class="btn ghost" data-act="best">ãƒ™ã‚¹ãƒˆã«ã™ã‚‹</button>` : ``}
            </span>
          </div>

          <div class="ansBody" id="ab_${a.id}">${esc(d.body||"")}</div>

          <div id="edit_${a.id}" style="display:none;margin-top:8px">
            <textarea id="editTa_${a.id}"></textarea>
            <div class="row" style="margin-top:6px">
              <button class="btn primary" data-act="saveEdit">ä¿å­˜</button>
              <button class="btn ghost" data-act="cancelEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="danger small" id="editWarn_${a.id}"></div>
          </div>

          <div style="margin-top:10px">
            <b class="small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè³ªå•è€…ã®ã¿ï¼‰</b>
            <div class="muted small" style="margin-top:4px">${esc(d.thanksText || "ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰")}</div>
            ${isQOwner ? `
              <div class="row" style="margin-top:6px">
                <input id="thanksIn_${a.id}" type="text" placeholder="ãŠç¤¼ï¼ˆçŸ­æ–‡ã§OKï¼‰" />
                <button class="btn ghost" data-act="thanks" style="width:auto">ãŠç¤¼é€ä¿¡</button>
              </div>
            ` : ``}
          </div>

          <div class="reply" id="replies_${a.id}" style="margin-top:12px">
            <b class="small">è¿”ä¿¡</b>
            <div id="replyList_${a.id}" class="muted small" style="margin-top:6px">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            <div style="margin-top:8px">
              <textarea id="replyTa_${a.id}" placeholder="è¿”ä¿¡ã‚’æ›¸ãï¼ˆè¿½è³ªå•ã‚‚OKï¼‰" style="min-height:70px"></textarea>
              <div class="row" style="margin-top:6px">
                <button class="btn ghost" data-act="replySend" style="width:auto">è¿”ä¿¡ã™ã‚‹</button>
              </div>
              <div class="danger small" id="replyWarn_${a.id}"></div>
            </div>
          </div>
        `;

        // ãƒœã‚¿ãƒ³å‚ç…§
        const btnHelpful = wrap.querySelector('[data-act="helpful"]');
        const btnReport  = wrap.querySelector('[data-act="report"]');
        const btnEdit    = wrap.querySelector('[data-act="edit"]');
        const btnDel     = wrap.querySelector('[data-act="del"]');
        const btnBest    = wrap.querySelector('[data-act="best"]');
        const btnThanks  = wrap.querySelector('[data-act="thanks"]');
        const btnSaveE   = wrap.querySelector('[data-act="saveEdit"]');
        const btnCancelE = wrap.querySelector('[data-act="cancelEdit"]');
        const btnReply   = wrap.querySelector('[data-act="replySend"]');

        // å‚è€ƒã«ãªã£ãŸï¼ˆãƒˆã‚°ãƒ«ï¼‰
        try{
          const h = await isHelpful(qid, a.id);
          btnHelpful.textContent = h ? "å‚è€ƒæ¸ˆã¿" : "å‚è€ƒã«ãªã£ãŸ";
        }catch{}

        btnHelpful?.addEventListener("click", async ()=>{
          try{
            await toggleHelpful(qid, a.id);
            await renderAnswers(qid);
          }catch(e){
            console.error(e);
            alert("æ“ä½œå¤±æ•—: " + (e?.message || e));
          }
        });

        // é€šå ±
        btnReport?.addEventListener("click", async ()=>{
          const reason = prompt("é€šå ±ç†ç”±ï¼ˆä¾‹ï¼šèª¹è¬—ä¸­å‚·ã€å€‹äººæƒ…å ±ã€åºƒå‘Šãªã©ï¼‰");
          if(!reason) return;
          try{
            await createReport({ type:"answer", qid, aid:a.id, reason });
            alert("é€šå ±ã—ã¾ã—ãŸ");
          }catch(e){
            console.error(e);
            alert("é€šå ±å¤±æ•—: " + (e?.message || e));
          }
        });

        // ç·¨é›†
        btnEdit?.addEventListener("click", ()=>{
          const boxE = document.getElementById("edit_"+a.id);
          boxE.style.display = "block";
          document.getElementById("editTa_"+a.id).value = d.body || "";
          document.getElementById("editWarn_"+a.id).textContent = "";
        });

        btnCancelE?.addEventListener("click", ()=>{
          document.getElementById("edit_"+a.id).style.display = "none";
        });

        btnSaveE?.addEventListener("click", async ()=>{
          const ta = document.getElementById("editTa_"+a.id);
          const text = (ta.value||"").trim();
          if(!text) return alert("æœ¬æ–‡ãŒç©ºã§ã™");
          if(containsDanger(text)){
            document.getElementById("editWarn_"+a.id).textContent = "âš  å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ–­å®šè¡¨ç¾ã¯é¿ã‘ã¦ã­ã€‚";
            return;
          }
          try{
            await updateAnswer(qid, a.id, { body:text });
            await renderAnswers(qid);
          }catch(e){
            console.error(e);
            alert("æ›´æ–°å¤±æ•—: " + (e?.message || e));
          }
        });

        // å‰Šé™¤
        btnDel?.addEventListener("click", async ()=>{
          if(!confirm("ã“ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰")) return;
          try{
            await softDeleteAnswer(qid, a.id);
            await renderAnswers(qid);
          }catch(e){
            console.error(e);
            alert("å‰Šé™¤å¤±æ•—: " + (e?.message || e));
          }
        });

        // ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ï¼ˆè³ªå•è€…ã®ã¿ï¼‰
        btnBest?.addEventListener("click", async ()=>{
          if(!confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await setBestAnswer(qid, a.id);
            await renderQuestion(qid);
            await renderAnswers(qid);
          }catch(e){
            console.error(e);
            alert("è¨­å®šå¤±æ•—: " + (e?.message || e));
          }
        });

        // ãŠç¤¼ï¼ˆè³ªå•è€…ã®ã¿ï¼‰
        btnThanks?.addEventListener("click", async ()=>{
          const v = document.getElementById("thanksIn_"+a.id)?.value || "";
          const text = v.trim();
          if(!text) return alert("ãŠç¤¼ã®æ–‡ã‚’å…¥åŠ›ã—ã¦ã­");
          if(containsDanger(text)){
            alert("å±é™ºãƒ¯ãƒ¼ãƒ‰ã£ã½ã„è¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã€‚æŸ”ã‚‰ã‹ã„è¨€ã„æ–¹ã«ã—ã¦ã­ã€‚");
            return;
          }
          try{
            await setThanks(qid, a.id, text);
            await renderAnswers(qid);
          }catch(e){
            console.error(e);
            alert("é€ä¿¡å¤±æ•—: " + (e?.message || e));
          }
        });

        // è¿”ä¿¡ï¼šèª­ã¿è¾¼ã¿ï¼†æŠ•ç¨¿
        await renderReplies(qid, a.id, isQOwner, isAOwner);

        btnReply?.addEventListener("click", async ()=>{
          const ta = document.getElementById("replyTa_"+a.id);
          const text = (ta.value||"").trim();
          if(!text) return;

          if(containsDanger(text)){
            document.getElementById("replyWarn_"+a.id).textContent = "âš  å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ–­å®š/æ”»æ’ƒè¡¨ç¾ã¯é¿ã‘ã¦ã­ã€‚";
            return;
          }else{
            document.getElementById("replyWarn_"+a.id).textContent = "";
          }

          btnReply.disabled = true;
          try{
            await addReply(qid, a.id, { body:text });
            ta.value = "";
            await renderReplies(qid, a.id, isQOwner, isAOwner);
          }catch(e){
            console.error(e);
            alert("è¿”ä¿¡å¤±æ•—: " + (e?.message || e));
          }finally{
            btnReply.disabled = false;
          }
        });

        box.appendChild(wrap);
      }
    }

    async function renderReplies(qid, aid){
      const list = await listReplies(qid, aid);
      const live = list.filter(r => !r.data?.deleted);

      const root = document.getElementById("replyList_"+aid);
      if(!live.length){
        root.innerHTML = `<span class="muted">è¿”ä¿¡ãªã—</span>`;
        return;
      }

      const html = live.map(r=>{
        const d = r.data || {};
        const mine = d.ownerUid === currentUid;
        return `
          <div style="margin:8px 0">
            <div class="muted small">${fmtTime(d.createdAt)} ${mine ? " / ã‚ãªãŸ" : ""}</div>
            <div style="white-space:pre-wrap">${esc(d.body||"")}</div>
            <div class="row" style="margin-top:4px;gap:6px">
              ${mine ? `<button class="btn ghost" data-ract="redit" data-rid="${r.id}" style="width:auto">ç·¨é›†</button>` : ``}
              ${mine ? `<button class="btn ghost danger" data-ract="rdel" data-rid="${r.id}" style="width:auto">å‰Šé™¤</button>` : ``}
              <button class="btn ghost" data-ract="rrep" data-rid="${r.id}" style="width:auto">é€šå ±</button>
            </div>
            <div id="re_${aid}_${r.id}" style="display:none;margin-top:6px">
              <textarea id="reTa_${aid}_${r.id}" style="min-height:70px"></textarea>
              <div class="row" style="margin-top:6px">
                <button class="btn primary" data-ract="rsave" data-rid="${r.id}" style="width:auto">ä¿å­˜</button>
                <button class="btn ghost" data-ract="rcancel" data-rid="${r.id}" style="width:auto">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
              <div class="danger small" id="reWarn_${aid}_${r.id}"></div>
            </div>
          </div>
        `;
      }).join("");

      root.innerHTML = html;

      // ã‚¤ãƒ™ãƒ³ãƒˆ
      root.querySelectorAll('[data-ract="redit"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const rid = btn.getAttribute("data-rid");
          document.getElementById("re_"+aid+"_"+rid).style.display = "block";
          document.getElementById("reTa_"+aid+"_"+rid).value =
            (live.find(x=>x.id===rid)?.data?.body) || "";
          document.getElementById("reWarn_"+aid+"_"+rid).textContent = "";
        });
      });

      root.querySelectorAll('[data-ract="rcancel"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const rid = btn.getAttribute("data-rid");
          document.getElementById("re_"+aid+"_"+rid).style.display = "none";
        });
      });

      root.querySelectorAll('[data-ract="rsave"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const rid = btn.getAttribute("data-rid");
          const ta = document.getElementById("reTa_"+aid+"_"+rid);
          const text = (ta.value||"").trim();
          if(!text) return alert("æœ¬æ–‡ãŒç©ºã§ã™");
          if(containsDanger(text)){
            document.getElementById("reWarn_"+aid+"_"+rid).textContent = "âš  å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
            return;
          }
          try{
            await updateReply(qid, aid, rid, { body:text });
            await renderReplies(qid, aid);
          }catch(e){
            console.error(e);
            alert("æ›´æ–°å¤±æ•—: " + (e?.message || e));
          }
        });
      });

      root.querySelectorAll('[data-ract="rdel"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const rid = btn.getAttribute("data-rid");
          if(!confirm("è¿”ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await softDeleteReply(qid, aid, rid);
            await renderReplies(qid, aid);
          }catch(e){
            console.error(e);
            alert("å‰Šé™¤å¤±æ•—: " + (e?.message || e));
          }
        });
      });

      root.querySelectorAll('[data-ract="rrep"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const rid = btn.getAttribute("data-rid");
          const reason = prompt("é€šå ±ç†ç”±ï¼ˆä¾‹ï¼šèª¹è¬—ä¸­å‚·ã€å€‹äººæƒ…å ±ã€åºƒå‘Šãªã©ï¼‰");
          if(!reason) return;
          try{
            await createReport({ type:"reply", qid, aid, rid, reason });
            alert("é€šå ±ã—ã¾ã—ãŸ");
          }catch(e){
            console.error(e);
            alert("é€šå ±å¤±æ•—: " + (e?.message || e));
          }
        });
      });
    }

    boot();
  </script>
</body>
</html>
