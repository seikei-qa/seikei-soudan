<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è³ªå•è©³ç´° - æ•´å½¢ç›¸è«‡å®¤</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Google tag (gtag.js) â€»ã‚ãªãŸã®è¨ˆæ¸¬IDã«åˆã‚ã›ã¦ã­ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4QH9F5T9PD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4QH9F5T9PD');
  </script>
</head>

<body>
  <div class="wrap">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="topbar">
      <div class="brand">æ•´å½¢ç›¸è«‡å®¤ï¼ˆåŒ¿åQ&Aï¼‰</div>
      <div class="tabs">
        <a class="tab" href="./index.html">ä¸€è¦§</a>
        <a class="tab" href="./ask.html">è³ªå•ã™ã‚‹</a>
        <a class="tab" href="./rank.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="msg" class="card" style="display:none"></div>

    <!-- è³ªå•ã‚«ãƒ¼ãƒ‰ -->
    <div id="qCard" class="card">
      <div class="muted small" id="qMetaTop">èª­ã¿è¾¼ã¿ä¸­...</div>
      <h1 id="qTitle" style="margin:8px 0 6px 0">...</h1>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin:10px 0;">
        <button id="copyBtn" class="btn ghost">URLã‚³ãƒ”ãƒ¼</button>
        <button id="watchBtn" class="btn ghost">â˜† ä¿å­˜</button>
        <button id="likeBtn" class="btn ghost">å…±æ„Ÿ</button>
        <button id="reportQBtn" class="btn ghost">é€šå ±</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="loginBtn" class="btn ghost" style="width:auto">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</button>
        <span class="muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç‹™ã†äººå‘ã‘ã€‚è³ªå•ã ã‘ãªã‚‰ä¸è¦ã€‚</span>
      </div>

      <div class="muted" id="qMeta" style="margin-top:10px"></div>
      <div id="qBody" style="white-space:pre-wrap; margin-top:10px"></div>

      <div class="row" style="gap:8px; margin-top:12px; flex-wrap:wrap;">
        <button id="editQBtn" class="btn ghost" style="display:none">ç·¨é›†</button>
        <button id="delQBtn" class="btn ghost danger" style="display:none">å‰Šé™¤</button>
      </div>

      <!-- è³ªå•ç·¨é›† -->
      <div id="qEditBox" style="display:none; margin-top:12px">
        <div class="muted small">è³ªå•ã‚’ç·¨é›†</div>
        <input id="qEditTitle" class="input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="margin-top:6px"/>
        <textarea id="qEditBody" class="textarea" placeholder="æœ¬æ–‡" style="margin-top:8px; min-height:120px"></textarea>
        <div class="row" style="gap:8px; margin-top:8px">
          <button id="qEditSave" class="btn primary">ä¿å­˜</button>
          <button id="qEditCancel" class="btn ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="qEditWarn" class="danger small" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- å›ç­”æŠ•ç¨¿ -->
    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 style="margin:0">å›ç­”ã™ã‚‹</h2>
        <span class="muted">ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</span>
      </div>

      <textarea id="ansText" class="textarea" placeholder="ã§ãã‚‹ã ã‘å…·ä½“çš„ã«ã€‚çµŒé¨“è«‡ã‚„æ ¹æ‹ ãŒã‚ã‚‹ã¨å¼·ã„ã§ã™ã€‚" style="min-height:120px; margin-top:10px"></textarea>
      <div id="ansWarn" class="danger small" style="margin-top:6px"></div>
      <button id="ansPost" class="btn primary" style="margin-top:10px">å›ç­”ã‚’æŠ•ç¨¿</button>
    </div>

    <!-- å›ç­”ä¸€è¦§ -->
    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 style="margin:0">å›ç­”ä¸€è¦§</h2>
        <div class="muted small" id="ansCount">0ä»¶</div>
      </div>
      <div id="answersBox" style="margin-top:10px"></div>
    </div>

    <!-- âœ… é–¢é€£è³ªå•ï¼ˆè¿½åŠ ï¼‰ -->
    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 style="margin:0">é–¢é€£è³ªå•</h2>
        <div class="muted small" id="relMeta"></div>
      </div>
      <div id="relatedBox" style="margin-top:10px"></div>
      <div class="muted small" style="margin-top:10px">
        â€»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ã®é¡ä¼¼åº¦ã§è‡ªå‹•è¡¨ç¤ºã—ã¦ã„ã¾ã™
      </div>
    </div>

    <div class="footer muted small" style="margin:18px 0 6px 0; text-align:center">
      <a href="./terms.html">åˆ©ç”¨è¦ç´„</a> ãƒ» <a href="./privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</a> ãƒ» <a href="./contact.html">é€£çµ¡ãƒ»ãŠå•ã„åˆã‚ã›</a>
    </div>
  </div>

<script type="module">
  import {
    esc, containsDanger, copyToClipboard,
    tokenize, andMatch,              // âœ… é–¢é€£è³ªå•ç”¨ã«è¿½åŠ 
    ensureAnonAuth, optionalGoogleLogin,
    getSiteConfig,
    listQuestions,                   // âœ… é–¢é€£è³ªå•ç”¨ã«è¿½åŠ 
    getQuestion, updateQuestion, softDeleteQuestion,
    listAnswers, addAnswer, updateAnswer, softDeleteAnswer,
    setBestAnswer, setThanks,
    toggleHelpful, isHelpful,
    listReplies, addReply, updateReply, softDeleteReply,
    toggleLikeQuestion, isLiked,
    toggleWatchQuestion, isWatching,
    createReport,
    currentUid
  } from "./app.js";

  // ========= util =========
  const $ = (id)=>document.getElementById(id);
  function qsParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }
  function showMsg(html, kind=""){
    const el = $("msg");
    el.style.display = "block";
    el.innerHTML = html;
    el.classList.remove("danger","ok");
    if(kind) el.classList.add(kind);
  }
  function hideMsg(){ $("msg").style.display="none"; $("msg").innerHTML=""; }
  function fmtTime(ts){
    try{
      if(!ts) return "";
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}/${m}/${da} ${hh}:${mm}`;
    }catch{
      return "";
    }
  }
  function clampText(s, max=140){
    const t = String(s||"").replace(/\s+/g," ").trim();
    if(t.length <= max) return t;
    return t.slice(0, max) + "â€¦";
  }
  function tokensFromQuestion(q){
    // title/body/tags ã‚’ã¾ã¨ã‚ã¦ token åŒ–
    const tags = Array.isArray(q?.tags) ? q.tags.join(" ") : (q?.tags || "");
    const cat  = q?.category || "";
    const hay  = `${q?.title||""} ${q?.body||""} ${tags} ${cat}`.toLowerCase();
    // tokenize ã¯ app.js ã®ã‚„ã¤ï¼ˆç©ºç™½åŒºåˆ‡ã‚Šï¼‰
    // æ—¥æœ¬èªã¯ç©ºç™½ãŒå°‘ãªã„ã®ã§ã€ã‚¿ã‚°ãƒ»ã‚«ãƒ†ã‚´ãƒªãŒåŠ¹ãã‚„ã™ã„è¨­è¨ˆã«ã™ã‚‹
    const ts = tokenize(hay);

    // é‡è¦ãƒ¯ãƒ¼ãƒ‰ã ã‘å°‘ã—è¶³ã™ï¼ˆç°¡æ˜“ï¼‰
    const extra = [];
    for(const w of ["åŸ‹æ²¡","äºŒé‡","é¼»","è±Šèƒ¸","è„‚è‚ª","ã‚¯ãƒ","ç³¸","ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸","ãƒœãƒˆãƒƒã‚¯ã‚¹","ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ","ä¿®æ­£","å¾Œæ‚”","è…«ã‚Œ"]){
      if(hay.includes(w)) extra.push(w);
    }
    const set = new Set([...ts, ...extra].filter(Boolean));
    return Array.from(set).slice(0, 40);
  }
  function scoreRelated(baseTokens, q){
    // å…±é€štokenæ•° + ã‚¿ã‚°ä¸€è‡´ã‚’åŠ ç‚¹
    const tags = Array.isArray(q?.tags) ? q.tags.join(" ") : (q?.tags || "");
    const cat  = q?.category || "";
    const hay  = `${q?.title||""} ${q?.body||""} ${tags} ${cat}`.toLowerCase();

    let score = 0;
    for(const t of baseTokens){
      if(t.length >= 2 && hay.includes(t)) score += 1;
    }
    // è»½ã„ãƒ–ãƒ¼ã‚¹ãƒˆ
    if(cat && hay.includes(String(cat).toLowerCase())) score += 1;
    return score;
  }

  const qid = qsParam("id");
  if(!qid){
    showMsg("URLãŒä¸æ­£ã§ã™ï¼ˆid ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰","danger");
  }

  let qData = null;
  let likedNow = false;
  let watchingNow = false;

  // ========= boot =========
  async function boot(){
    try{
      await ensureAnonAuth();

      // ãƒ¡ãƒ³ãƒ†è¡¨ç¤º
      try{
        const sc = await getSiteConfig();
        if(sc?.maintenance){
          showMsg(`<b>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</b><div class="muted" style="margin-top:6px">${esc(sc.message||"")}</div>`,"danger");
        }else{
          hideMsg();
        }
      }catch{}

      await loadQuestion();
      await renderAnswers();
      await refreshButtons();
      await renderRelated(); // âœ… è¿½åŠ 
      bind();
    }catch(e){
      console.error(e);
      showMsg("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—å¾…ã£ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚<br><span class='muted small'>" + esc(e?.message||String(e)) + "</span>","danger");
    }
  }

  async function loadQuestion(){
    $("qMetaTop").textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    const res = await getQuestion(qid);
    if(!res){
      showMsg("ã“ã®è³ªå•ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚","danger");
      return;
    }
    qData = res.data;

    if(qData.deleted){
      showMsg("ã“ã®è³ªå•ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚","danger");
    }

    $("qTitle").textContent = qData.title || "(ç„¡é¡Œ)";
    $("qBody").textContent = qData.body || "";

    const status = qData.bestAnswerId ? "ğŸŸ¢ è§£æ±º" : "ğŸŸ¡ æœªè§£æ±º";
    $("qMetaTop").textContent = `UID: ${currentUid}`;
    $("qMeta").textContent =
      `å…±æ„Ÿ:${qData.likeCount||0} / å›ç­”:${qData.answerCount||0} / ä½œæˆ:${fmtTime(qData.createdAt)} / ${status}`;

    const isOwner = (qData.ownerUid && qData.ownerUid === currentUid);
    $("editQBtn").style.display = isOwner ? "" : "none";
    $("delQBtn").style.display  = isOwner ? "" : "none";
  }

  async function refreshButtons(){
    try{ likedNow = await isLiked(qid); }catch{ likedNow = false; }
    $("likeBtn").textContent = likedNow ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";

    try{ watchingNow = await isWatching(qid); }catch{ watchingNow = false; }
    $("watchBtn").textContent = watchingNow ? "â˜… ä¿å­˜ä¸­" : "â˜† ä¿å­˜";
  }

  // ========= related (NEW) =========
  async function renderRelated(){
    const box = $("relatedBox");
    const meta = $("relMeta");
    box.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;
    meta.textContent = "";

    try{
      const all = await listQuestions(); // å…¨ä»¶å–å¾—ï¼ˆå°è¦æ¨¡ãªã‚‰OKï¼‰
      const live = (all||[])
        .filter(x => x?.id && x?.id !== qid)
        .map(x => ({ id:x.id, data:x.data }))
        .filter(x => x.data && !x.data.deleted);

      if(!live.length){
        box.innerHTML = `<div class="muted">é–¢é€£è³ªå•ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      const baseTokens = tokensFromQuestion(qData);
      // ã‚¹ã‚³ã‚¢ä»˜ã‘
      const scored = live.map(x => {
        const s = scoreRelated(baseTokens, x.data);
        return { ...x, score:s };
      });

      // 0ç‚¹ã¯é™¤å¤–ã—ã¤ã¤ã€è¶³ã‚Šãªã‘ã‚Œã°æ–°ç€ã§è£œã†
      const positive = scored.filter(x => x.score > 0).sort((a,b)=>b.score-a.score);
      const fresh    = scored.sort((a,b)=>{
        const ta = a.data.createdAt?.toDate ? a.data.createdAt.toDate().getTime() : 0;
        const tb = b.data.createdAt?.toDate ? b.data.createdAt.toDate().getTime() : 0;
        return tb - ta;
      });

      const picked = [];
      const used = new Set();
      for(const x of positive){
        if(picked.length >= 8) break;
        used.add(x.id); picked.push(x);
      }
      for(const x of fresh){
        if(picked.length >= 8) break;
        if(used.has(x.id)) continue;
        used.add(x.id); picked.push(x);
      }

      meta.textContent = `${picked.length}ä»¶è¡¨ç¤º`;

      box.innerHTML = picked.map(x=>{
        const d = x.data || {};
        const title = esc(d.title || "(ç„¡é¡Œ)");
        const snippet = esc(clampText(d.body || "", 120));
        const st = d.bestAnswerId ? "ğŸŸ¢" : "ğŸŸ¡";
        const like = d.likeCount || 0;
        const ans = d.answerCount || 0;
        return `
          <a class="card" href="./q.html?id=${encodeURIComponent(x.id)}" style="display:block; margin-top:8px; text-decoration:none">
            <div class="row" style="justify-content:space-between; gap:8px; align-items:flex-start">
              <div style="font-weight:700">${st} ${title}</div>
              <div class="muted small" style="white-space:nowrap">${like}å…±æ„Ÿ / ${ans}å›ç­”</div>
            </div>
            <div class="muted" style="
              margin-top:6px;
              display:-webkit-box;
              -webkit-line-clamp:3;
              -webkit-box-orient:vertical;
              overflow:hidden;
              line-height:1.35;
            ">${snippet}</div>
          </a>
        `;
      }).join("");
    }catch(e){
      console.error(e);
      box.innerHTML = `<div class="danger small">é–¢é€£è³ªå•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
    }
  }

  // ========= answers =========
  async function renderAnswers(){
    const box = $("answersBox");
    box.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;

    const list = await listAnswers(qid);
    const live = (list||[]).filter(a => !a.data?.deleted);

    $("ansCount").textContent = `${live.length}ä»¶`;

    if(!live.length){
      box.innerHTML = `<div class="muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    box.innerHTML = "";
    for(const a of live){
      const d = a.data || {};
      const isOwner = (d.ownerUid && d.ownerUid === currentUid);
      const isQOwner = (qData?.ownerUid && qData.ownerUid === currentUid);

      const wrap = document.createElement("div");
      wrap.className = "ans";

      const head = document.createElement("div");
      head.className = "ansHead";

      const left = document.createElement("div");
      left.innerHTML = `
        <b>${d.best ? "ğŸ† ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼" : "å›ç­”"}</b>
        <span class="muted small" style="margin-left:8px">${esc(fmtTime(d.createdAt))}</span>
        <span class="pill" style="margin-left:8px">å‚è€ƒ:${d.helpfulCount||0}</span>
        ${d.best ? `<span class="pill" style="margin-left:6px">é¸ã°ã‚Œã¾ã—ãŸ</span>` : ``}
      `;

      const right = document.createElement("div");
      right.className = "row";
      right.style.gap = "6px";
      right.style.flexWrap = "wrap";
      right.style.justifyContent = "flex-end";

      const helpfulBtn = document.createElement("button");
      helpfulBtn.className = "btn ghost";
      helpfulBtn.dataset.act = "helpful";
      helpfulBtn.dataset.aid = a.id;
      helpfulBtn.textContent = "å‚è€ƒã«ãªã£ãŸ";
      right.appendChild(helpfulBtn);

      const reportBtn = document.createElement("button");
      reportBtn.className = "btn ghost";
      reportBtn.dataset.act = "reportA";
      reportBtn.dataset.aid = a.id;
      reportBtn.textContent = "é€šå ±";
      right.appendChild(reportBtn);

      if(isQOwner){
        const bestBtn = document.createElement("button");
        bestBtn.className = "btn ghost";
        bestBtn.dataset.act = "best";
        bestBtn.dataset.aid = a.id;
        bestBtn.textContent = "ãƒ™ã‚¹ãƒˆã«ã™ã‚‹";
        right.appendChild(bestBtn);

        const thanksBtn = document.createElement("button");
        thanksBtn.className = "btn ghost";
        thanksBtn.dataset.act = "thanksOpen";
        thanksBtn.dataset.aid = a.id;
        thanksBtn.textContent = "ãŠç¤¼";
        right.appendChild(thanksBtn);
      }

      if(isOwner){
        const editBtn = document.createElement("button");
        editBtn.className = "btn ghost";
        editBtn.dataset.act = "editA";
        editBtn.dataset.aid = a.id;
        editBtn.textContent = "ç·¨é›†";
        right.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn ghost danger";
        delBtn.dataset.act = "delA";
        delBtn.dataset.aid = a.id;
        delBtn.textContent = "å‰Šé™¤";
        right.appendChild(delBtn);
      }

      head.appendChild(left);
      head.appendChild(right);
      wrap.appendChild(head);

      const body = document.createElement("div");
      body.className = "ansBody";
      body.id = "ab_" + a.id;
      body.style.whiteSpace = "pre-wrap";
      body.textContent = d.body || "";
      wrap.appendChild(body);

      if(d.thanksText){
        const thanks = document.createElement("div");
        thanks.className = "card";
        thanks.style.marginTop = "8px";
        thanks.innerHTML = `<div class="muted small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆ</div><div style="white-space:pre-wrap;margin-top:6px">${esc(d.thanksText)}</div>`;
        wrap.appendChild(thanks);
      }

      const editBox = document.createElement("div");
      editBox.id = "ae_" + a.id;
      editBox.style.display = "none";
      editBox.style.marginTop = "8px";
      editBox.innerHTML = `
        <textarea class="textarea" id="aeTa_${a.id}" style="min-height:100px"></textarea>
        <div class="row" style="gap:8px;margin-top:6px;flex-wrap:wrap">
          <button class="btn primary" data-act="saveA" data-aid="${a.id}">ä¿å­˜</button>
          <button class="btn ghost" data-act="cancelA" data-aid="${a.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div class="danger small" id="aeWarn_${a.id}" style="margin-top:6px"></div>
      `;
      wrap.appendChild(editBox);

      const thBox = document.createElement("div");
      thBox.id = "th_" + a.id;
      thBox.style.display = "none";
      thBox.style.marginTop = "8px";
      thBox.innerHTML = `
        <div class="muted small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè³ªå•è€…ã®ã¿ï¼‰</div>
        <textarea class="textarea" id="thTa_${a.id}" style="min-height:90px" placeholder="ã‚ã‚ŠãŒã¨ã†ï¼è¿½åŠ ã®è£œè¶³ãªã©"></textarea>
        <div class="row" style="gap:8px;margin-top:6px;flex-wrap:wrap">
          <button class="btn primary" data-act="thanksSave" data-aid="${a.id}">é€ä¿¡</button>
          <button class="btn ghost" data-act="thanksCancel" data-aid="${a.id}">é–‰ã˜ã‚‹</button>
        </div>
        <div class="danger small" id="thWarn_${a.id}" style="margin-top:6px"></div>
      `;
      wrap.appendChild(thBox);

      const repComposer = document.createElement("div");
      repComposer.className = "card";
      repComposer.style.marginTop = "10px";
      repComposer.innerHTML = `
        <div class="muted small">è¿”ä¿¡</div>
        <textarea class="textarea" id="rpTa_${a.id}" style="min-height:80px;margin-top:6px" placeholder="å›ç­”ã¸ã®è¿”ä¿¡ã‚’æ›¸ã‘ã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰"></textarea>
        <div class="row" style="gap:8px;margin-top:6px;flex-wrap:wrap">
          <button class="btn primary" data-act="rpPost" data-aid="${a.id}">è¿”ä¿¡ã‚’æŠ•ç¨¿</button>
        </div>
        <div class="danger small" id="rpWarn_${a.id}" style="margin-top:6px"></div>
      `;
      wrap.appendChild(repComposer);

      const replyRoot = document.createElement("div");
      replyRoot.id = "replyList_" + a.id;
      replyRoot.style.marginTop = "8px";
      wrap.appendChild(replyRoot);

      box.appendChild(wrap);

      try{
        const h = await isHelpful(qid, a.id);
        if(h) helpfulBtn.textContent = "å‚è€ƒæ¸ˆã¿";
      }catch{}

      await renderReplies(qid, a.id);
    }
  }

  async function renderReplies(qid, aid){
    const root = document.getElementById("replyList_" + aid);
    if(!root) return;

    let list = [];
    try{
      list = await listReplies(qid, aid);
    }catch(e){
      console.warn(e);
      root.innerHTML = `<div class="muted small">è¿”ä¿¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
      return;
    }
    const live = (list||[]).filter(r => !r.data?.deleted);

    if(!live.length){
      root.innerHTML = `<span class="muted small">è¿”ä¿¡ãªã—</span>`;
      return;
    }

    const html = live.map(r=>{
      const d = r.data || {};
      const mine = (d.ownerUid && d.ownerUid === currentUid);
      return `
        <div class="card" style="margin-top:8px">
          <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
            <div class="muted small">${esc(fmtTime(d.createdAt))}</div>
            <div class="row" style="gap:6px; flex-wrap:wrap">
              <button class="btn ghost" data-act="reportR" data-aid="${aid}" data-rid="${r.id}">é€šå ±</button>
              ${mine ? `<button class="btn ghost" data-act="editR" data-aid="${aid}" data-rid="${r.id}">ç·¨é›†</button>` : ``}
              ${mine ? `<button class="btn ghost danger" data-act="delR" data-aid="${aid}" data-rid="${r.id}">å‰Šé™¤</button>` : ``}
            </div>
          </div>
          <div id="rb_${aid}_${r.id}" style="white-space:pre-wrap; margin-top:6px">${esc(d.body||"")}</div>

          <div id="re_${aid}_${r.id}" style="display:none; margin-top:8px">
            <textarea class="textarea" id="reTa_${aid}_${r.id}" style="min-height:80px"></textarea>
            <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap">
              <button class="btn primary" data-act="saveR" data-aid="${aid}" data-rid="${r.id}">ä¿å­˜</button>
              <button class="btn ghost" data-act="cancelR" data-aid="${aid}" data-rid="${r.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="danger small" id="reWarn_${aid}_${r.id}" style="margin-top:6px"></div>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = html;
  }

  // ========= bind =========
  function bind(){
    $("copyBtn").addEventListener("click", async ()=>{
      await copyToClipboard(location.href);
      showMsg("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ","ok");
      setTimeout(hideMsg, 1200);
    });

    $("loginBtn").addEventListener("click", async ()=>{
      const r = await optionalGoogleLogin();
      if(r.ok){
        showMsg("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ","ok");
        setTimeout(hideMsg, 1200);
        await loadQuestion();
        await renderAnswers();
        await refreshButtons();
        await renderRelated(); // âœ…
      }else{
        showMsg("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ<br><span class='muted small'>" + esc(r.error||"") + "</span>", "danger");
      }
    });

    $("likeBtn").addEventListener("click", async ()=>{
      try{
        const r = await toggleLikeQuestion(qid);
        likedNow = r.liked;
        $("likeBtn").textContent = likedNow ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";
        await loadQuestion();
        await renderRelated(); // âœ… é–¢é€£ã‚‚æ›´æ–°
      }catch(e){
        showMsg("å…±æ„Ÿã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });

    $("watchBtn").addEventListener("click", async ()=>{
      try{
        const r = await toggleWatchQuestion(qid);
        watchingNow = r.watching;
        $("watchBtn").textContent = watchingNow ? "â˜… ä¿å­˜ä¸­" : "â˜† ä¿å­˜";
      }catch(e){
        showMsg("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });

    $("reportQBtn").addEventListener("click", async ()=>{
      if(!confirm("ã“ã®è³ªå•ã‚’é€šå ±ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try{
        await createReport({ type:"question", qid, reason:"user_report" });
        showMsg("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ","ok");
        setTimeout(hideMsg, 1200);
      }catch(e){
        showMsg("é€šå ±ã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });

    $("ansPost").addEventListener("click", async ()=>{
      const text = $("ansText").value.trim();
      $("ansWarn").textContent = "";
      if(!text){ $("ansWarn").textContent = "æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      if(containsDanger(text)){ $("ansWarn").textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚è¡¨ç¾ã‚’ã‚„ã‚ã‚‰ã‹ãã—ã¦ãã ã•ã„ã€‚"; return; }

      try{
        await addAnswer(qid, { body:text });
        $("ansText").value = "";
        await loadQuestion();
        await renderAnswers();
        await renderRelated(); // âœ…
        showMsg("å›ç­”ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ","ok");
        setTimeout(hideMsg, 1200);
      }catch(e){
        console.error(e);
        showMsg("å›ç­”ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });

    $("editQBtn").addEventListener("click", ()=>{
      $("qEditBox").style.display = "";
      $("qEditTitle").value = qData?.title || "";
      $("qEditBody").value  = qData?.body || "";
      $("qEditWarn").textContent = "";
    });
    $("qEditCancel").addEventListener("click", ()=>{
      $("qEditBox").style.display = "none";
    });
    $("qEditSave").addEventListener("click", async ()=>{
      const t = $("qEditTitle").value.trim();
      const b = $("qEditBody").value.trim();
      $("qEditWarn").textContent = "";
      if(!t){ $("qEditWarn").textContent = "ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ã™"; return; }
      if(containsDanger(t+b)){ $("qEditWarn").textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚è¡¨ç¾ã‚’ã‚„ã‚ã‚‰ã‹ãã—ã¦ãã ã•ã„ã€‚"; return; }
      try{
        await updateQuestion(qid, { title:t, body:b });
        $("qEditBox").style.display = "none";
        await loadQuestion();
        await renderRelated(); // âœ…
        showMsg("æ›´æ–°ã—ã¾ã—ãŸ","ok");
        setTimeout(hideMsg, 1200);
      }catch(e){
        showMsg("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });
    $("delQBtn").addEventListener("click", async ()=>{
      if(!confirm("ã“ã®è³ªå•ã‚’å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try{
        await softDeleteQuestion(qid);
        showMsg("å‰Šé™¤ã—ã¾ã—ãŸã€‚ä¸€è¦§ã«æˆ»ã‚Šã¾ã™â€¦","ok");
        setTimeout(()=>location.href="./index.html", 800);
      }catch(e){
        showMsg("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","danger");
      }
    });

    $("answersBox").addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;

      const act = btn.dataset.act;
      const aid = btn.dataset.aid;
      const rid = btn.dataset.rid;

      try{
        if(act === "helpful"){
          const r = await toggleHelpful(qid, aid);
          btn.textContent = r.helpful ? "å‚è€ƒæ¸ˆã¿" : "å‚è€ƒã«ãªã£ãŸ";
          await renderAnswers();
          return;
        }
        if(act === "reportA"){
          if(!confirm("ã“ã®å›ç­”ã‚’é€šå ±ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await createReport({ type:"answer", qid, aid, reason:"user_report" });
          showMsg("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }
        if(act === "best"){
          if(!confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await setBestAnswer(qid, aid);
          await loadQuestion();
          await renderAnswers();
          await renderRelated(); // âœ…
          showMsg("ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«è¨­å®šã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }
        if(act === "thanksOpen"){
          const box = document.getElementById("th_"+aid);
          if(box) box.style.display = (box.style.display==="none" ? "" : "none");
          return;
        }
        if(act === "thanksCancel"){
          const box = document.getElementById("th_"+aid);
          if(box) box.style.display = "none";
          return;
        }
        if(act === "thanksSave"){
          const ta = document.getElementById("thTa_"+aid);
          const warn = document.getElementById("thWarn_"+aid);
          warn.textContent = "";
          const text = (ta?.value||"").trim();
          if(!text){ warn.textContent = "ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºã§ã™"; return; }
          if(containsDanger(text)){ warn.textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚"; return; }
          await setThanks(qid, aid, text);
          await renderAnswers();
          showMsg("ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ã‚Šã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }
        if(act === "editA"){
          const box = document.getElementById("ae_"+aid);
          const ta  = document.getElementById("aeTa_"+aid);
          const warn= document.getElementById("aeWarn_"+aid);
          warn.textContent = "";
          const body = document.getElementById("ab_"+aid)?.textContent || "";
          ta.value = body;
          box.style.display = "";
          return;
        }
        if(act === "cancelA"){
          const box = document.getElementById("ae_"+aid);
          if(box) box.style.display = "none";
          return;
        }
        if(act === "saveA"){
          const ta  = document.getElementById("aeTa_"+aid);
          const warn= document.getElementById("aeWarn_"+aid);
          warn.textContent = "";
          const text = (ta?.value||"").trim();
          if(!text){ warn.textContent = "æœ¬æ–‡ãŒç©ºã§ã™"; return; }
          if(containsDanger(text)){ warn.textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚"; return; }
          await updateAnswer(qid, aid, { body:text });
          await renderAnswers();
          showMsg("å›ç­”ã‚’æ›´æ–°ã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }
        if(act === "delA"){
          if(!confirm("ã“ã®å›ç­”ã‚’å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await softDeleteAnswer(qid, aid);
          await loadQuestion();
          await renderAnswers();
          await renderRelated(); // âœ…
          showMsg("å‰Šé™¤ã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }

        if(act === "rpPost"){
          const ta = document.getElementById("rpTa_"+aid);
          const warn = document.getElementById("rpWarn_"+aid);
          warn.textContent = "";
          const text = (ta?.value||"").trim();
          if(!text){ warn.textContent = "è¿”ä¿¡æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
          if(containsDanger(text)){ warn.textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚"; return; }

          await addReply(qid, aid, { body:text });
          ta.value = "";
          await renderReplies(qid, aid);
          showMsg("è¿”ä¿¡ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }

        if(act === "reportR"){
          if(!confirm("ã“ã®è¿”ä¿¡ã‚’é€šå ±ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await createReport({ type:"reply", qid, aid, rid, reason:"user_report" });
          showMsg("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }

        if(act === "editR"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          const ta  = document.getElementById(`reTa_${aid}_${rid}`);
          const warn= document.getElementById(`reWarn_${aid}_${rid}`);
          warn.textContent = "";
          const body = document.getElementById(`rb_${aid}_${rid}`)?.textContent || "";
          ta.value = body;
          box.style.display = "";
          return;
        }
        if(act === "cancelR"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          if(box) box.style.display = "none";
          return;
        }
        if(act === "saveR"){
          const ta  = document.getElementById(`reTa_${aid}_${rid}`);
          const warn= document.getElementById(`reWarn_${aid}_${rid}`);
          warn.textContent = "";
          const text = (ta?.value||"").trim();
          if(!text){ warn.textContent = "æœ¬æ–‡ãŒç©ºã§ã™"; return; }
          if(containsDanger(text)){ warn.textContent = "æ–­å®š/æ”»æ’ƒçš„ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚"; return; }
          await updateReply(qid, aid, rid, { body:text });
          await renderReplies(qid, aid);
          showMsg("è¿”ä¿¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }
        if(act === "delR"){
          if(!confirm("ã“ã®è¿”ä¿¡ã‚’å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await softDeleteReply(qid, aid, rid);
          await renderReplies(qid, aid);
          showMsg("å‰Šé™¤ã—ã¾ã—ãŸ","ok");
          setTimeout(hideMsg, 1200);
          return;
        }

      }catch(e){
        console.error(e);
        showMsg("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ<br><span class='muted small'>" + esc(e?.message||String(e)) + "</span>", "danger");
      }
    });
  }

  boot();
</script>
</body>
</html>
